<!DOCTYPE html>
<html lang="ko" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>JW Language Learning Player</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        darkbg: '#121212',
                        panel: '#1e1e1e',
                        lightbg: '#F1F5F9', /* Eye-comfort Greenish White */
                        lightpanel: '#F8FAFC',
                        accent: '#3b82f6'
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.2s ease-out',
                        'slide-down': 'slideDown 0.2s ease-out',
                        'slide-up': 'slideUp 0.2s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideDown: {
                            '0%': { transform: 'translateY(-10px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(10px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>
    <!-- React & Babel CDNs -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&family=Noto+Sans+SC:wght@400;500;700&family=Noto+Serif+SC:wght@500;700&display=swap');
        
        /* Dynamic Viewport Height & Mobile Text Adjustments */
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; background-color: #121212; color: #e4e4e7; } 
        body { font-family: 'Inter', 'Noto Sans KR', sans-serif; -webkit-font-smoothing: antialiased; }
        
        .font-chinese-serif { font-family: 'Noto Serif SC', serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #18181b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #52525b; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #71717a; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        input[type=range] { -webkit-appearance: none; background: transparent; height: 4px; cursor: pointer; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 12px; width: 12px; border-radius: 50%; background: #3b82f6; margin-top: -4px; transition: transform 0.1s; }
        input[type=range]:hover::-webkit-slider-thumb { transform: scale(1.2); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #27272a; border-radius: 2px; }
        
        @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin-slow { animation: spin-slow 3s linear infinite; }
        @keyframes slide-up { from { transform: translate(-50%, 20px); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
        .toast-enter { animation: slide-up 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        mark.highlight { background-color: rgba(234, 179, 8, 0.6); color: white; border-radius: 2px; padding: 0 2px; font-weight: bold; }
        
        .touch-action-manipulation { touch-action: manipulation; }
    </style>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-G0RRE3LDRB"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      // Ï£ºÏùò: ÏïÑÎûò 'G-XXXXXXXXXX' Î∂ÄÎ∂ÑÏùÑ ÏïÑÍπå Î∞úÍ∏âÎ∞õÏùÄ Ïã§Ï†ú IDÎ°ú Íº≠ Î∞îÍøîÏ£ºÏÑ∏Ïöî!
      gtag('config', 'G-G0RRE3LDRB');
    </script>
</head>
<body class="bg-darkbg text-zinc-200">
    <div id="root" class="h-[100dvh] flex flex-col"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        // --- Helper Functions ---
        
        const findIndexByTime = (script, time) => {
            if (!script || script.length === 0) return -1;
            
            let left = 0;
            let right = script.length - 1;
            let result = -1;

            while (left <= right) {
                const mid = Math.floor((left + right) / 2);
                const item = script[mid];
                // Conservative endTime guess for search
                const endTime = item.end || (script[mid+1] ? script[mid+1].start : item.start + 10);

                if (time >= item.start && time < endTime) {
                    return mid; 
                }
                
                if (time < item.start) {
                    right = mid - 1;
                } else {
                    left = mid + 1;
                    result = mid; 
                }
            }
            return result;
        };

        // Gap-Aware Smart Merge Logic
        const getMatchingContent = (targetScript, startTime, endTime) => {
            if (!targetScript || targetScript.length === 0) return null;
            
            // Allow a small buffer for timing mismatches
            const buffer = 0.2; 
            const windowStart = startTime - buffer;
            const windowEnd = (endTime || (startTime + 5)) + buffer; 
            const windowDuration = windowEnd - windowStart;

            // 1. Find candidates strictly within window
            const candidates = targetScript.filter(t => {
                const tEnd = t.end || (t.start + 2); 
                const overlapStart = Math.max(windowStart, t.start);
                const overlapEnd = Math.min(windowEnd, tEnd);
                const overlapDuration = Math.max(0, overlapEnd - overlapStart);
                
                const tDuration = tEnd - t.start;
                // Basic overlap check
                return overlapDuration > 0.2 && (overlapDuration / tDuration > 0.4 || overlapDuration / windowDuration > 0.3);
            });

            if (candidates.length === 0) {
                // Fallback logic
                const idx = findIndexByTime(targetScript, startTime + 0.1);
                if (idx !== -1) {
                    const candidate = targetScript[idx];
                    if (Math.abs(candidate.start - startTime) < 1.0) {
                          return { ...candidate, isFallback: true };
                    }
                }
                return null;
            }

            // 2. Sort by start time
            candidates.sort((a, b) => a.start - b.start);

            // Gap Detection for Multi-Speaker
            let bestCandidates = candidates;
            
            for (let i = 0; i < candidates.length - 1; i++) {
                const currentEnd = candidates[i].end || (candidates[i].start + 2);
                const nextStart = candidates[i+1].start;
                
                if (nextStart - currentEnd > 0.5) {
                    // Gap detected! 
                    const baseCenter = (startTime + (endTime || startTime + 5)) / 2;
                    
                    bestCandidates = [candidates.reduce((best, curr) => {
                        const currCenter = (curr.start + (curr.end || curr.start + 2)) / 2;
                        const bestCenter = (best.start + (best.end || best.start + 2)) / 2;
                        return Math.abs(currCenter - baseCenter) < Math.abs(bestCenter - baseCenter) ? curr : best;
                    })];
                    break;
                }
            }

            // 3. Merge texts
            const combinedText = bestCandidates.map(c => c.text).join(' ');
            const combinedPinyin = bestCandidates.map(c => c.pinyin || '').join(' ');

            return { 
                text: combinedText, 
                pinyin: combinedPinyin.trim() ? combinedPinyin : null,
                start: bestCandidates[0].start 
            };
        };

        // --- Components ---

        const HighlightText = React.memo(({ text, highlight }) => {
            if (!highlight || !text) return <>{text}</>;
            const escapedHighlight = highlight.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const parts = text.split(new RegExp(`(${escapedHighlight})`, 'gi'));
            
            return (
                <span>
                    {parts.map((part, i) => 
                        part.toLowerCase() === highlight.toLowerCase() ? 
                        <mark key={i} className="highlight">{part}</mark> : part
                    )}
                </span>
            );
        });

        const Icon = React.memo(({ name, className = "w-5 h-5" }) => {
            if(name === 'skipBack') return <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 20 9 12l10-8v16Z"/><line x1="5" y1="19" x2="5" y2="5"/></svg>;
            if(name === 'skipForward') return <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m5 4 10 8-10 8V4Z"/><line x1="19" y1="5" x2="19" y2="19"/></svg>;
            if(name === 'repeat') return <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m17 2 4 4-4 4"/><path d="M3 11v-1a4 4 0 0 1 4-4h14"/><path d="m7 22-4-4 4-4"/><path d="M21 13v1a4 4 0 0 1-4 4H3"/></svg>;
            if(name === 'info') return <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>;
            if(name === 'arrowUp') return <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m18 15-6-6-6 6"/></svg>;
            if(name === 'arrowDown') return <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6 9 6 6 6-6"/></svg>;
            // Sun/Moon Icons for Theme Toggle
            if(name === 'sun') return <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>;
            if(name === 'moon') return <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>;
            // Headphone Icon for Audio
            if(name === 'headphone') return <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 18v-6a9 9 0 0 1 18 0v6"/><path d="M21 19a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3zM3 19a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2H3z"/></svg>;
            // [NEW] Auto-scroll Icon
            if(name === 'scroll') return <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 19-7-7"/><path d="m19 12-7 7"/><path d="M12 5v14"/></svg>;

            const icons = {
                play: <path d="m5 3 14 9-14 9V3z" />,
                pause: <path d="M6 4h4v16H6zm8 0h4v16h-4z" />,
                search: <React.Fragment><circle cx="11" cy="11" r="8" /><path d="m21 21-4.3-4.3" /></React.Fragment>,
                settings: <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.58,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z" />,
                x: <path d="M18 6 6 18M6 6l12 12"/>,
                volume: <path d="M11 5L6 9H2v6h4l5 4V5z" />,
                message: <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />,
                list: <React.Fragment><line x1="8" y1="6" x2="21" y2="6" /><line x1="8" y1="12" x2="21" y2="12" /><line x1="8" y1="18" x2="21" y2="18" /><line x1="3" y1="6" x2="3.01" y2="6" /><line x1="3" y1="12" x2="3.01" y2="12" /><line x1="3" y1="18" x2="3.01" y2="18" /></React.Fragment>,
                globe: <React.Fragment><circle cx="12" cy="12" r="10" /><path d="M12 2a14.5 14.5 0 0 0 0 20" /><path d="M2 12h20" /></React.Fragment>,
                alert: <React.Fragment><circle cx="12" cy="12" r="10" /><line x1="12" y1="8" x2="12" y2="12" /><line x1="12" y1="16" x2="12.01" y2="16" /></React.Fragment>,
                chevronDown: <path d="m6 9 6 6 6-6"/>,
                check: <path d="M20 6 9 17l-5-5"/>
            };

            return (
                <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="currentColor" stroke="none">
                    {icons[name] || null}
                </svg>
            );
        });

        const ScriptItem = React.memo(({ 
            item, idx, isActive, onClick, baseLang, fontSizes, showPinyin, 
            koContent, cnContent, enContent,
            autoScroll, searchQuery, langOrder, visibleLangs 
        }) => {
            const itemRef = useRef(null);

            useEffect(() => {
                if (isActive && itemRef.current && autoScroll) {
                    itemRef.current.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, [isActive, autoScroll]);

            const renderContent = (lang) => {
                if (!visibleLangs[lang]) return null;

                // Unified Highlight Style for Base Language (All colors behave like Korean)
                const isBase = baseLang === lang;
                const highlightClass = isBase && isActive 
                    ? 'font-bold text-blue-600 dark:text-blue-400' 
                    : 'text-slate-600 dark:text-zinc-300 group-hover:text-slate-900 dark:group-hover:text-white';

                if (lang === 'ko') {
                    return koContent && (
                        <div key={lang} style={{ fontSize: `${fontSizes.ko}px` }} className={`leading-relaxed mb-1 transition-colors cursor-text select-text ${highlightClass}`}>
                            <HighlightText text={koContent.text} highlight={searchQuery} />
                        </div>
                    );
                } else if (lang === 'cn') {
                    return cnContent && (
                        <div key={lang} className={`leading-relaxed mb-1 cursor-text select-text ${highlightClass}`}>
                            {showPinyin && cnContent.pinyin && (
                                <div style={{ fontSize: `${Math.max(10, fontSizes.cn * 0.7)}px` }} className="text-blue-500 dark:text-blue-400/80 mb-0.5 font-light">{cnContent.pinyin}</div>
                            )}
                            <div style={{ fontSize: `${fontSizes.cn}px` }} className="font-chinese-serif">
                                <HighlightText text={cnContent.text} highlight={searchQuery} />
                            </div>
                        </div>
                    );
                } else if (lang === 'en') {
                    return enContent && (
                        <div key={lang} style={{ fontSize: `${fontSizes.en}px` }} className={`italic leading-snug cursor-text select-text ${highlightClass}`}>
                            <HighlightText text={enContent.text} highlight={searchQuery} />
                        </div>
                    );
                }
                return null;
            };

            return (
                <div 
                    onClick={() => onClick(item.start)}
                    ref={itemRef}
                    className={`mb-2 px-3 py-3 rounded-lg cursor-pointer transition-all duration-200 relative group border-l-4 flex flex-col gap-3
                        ${isActive 
                            ? 'bg-[#F0F6FE] dark:bg-zinc-800/80 border-blue-500' 
                            : 'hover:bg-green-50 dark:hover:bg-zinc-800/40 border-transparent'
                        }`}
                >
                    <div className="absolute top-2 right-2 flex items-center gap-1">
                        {/* [MODIFIED] Auto-scroll Icon */}
                        {isActive && autoScroll && (
                            <Icon name="scroll" className="w-3 h-3 text-blue-500 animate-bounce" />
                        )}
                        <span className="text-[10px] md:text-xs font-mono text-slate-400 dark:text-zinc-500 group-hover:text-slate-600 dark:group-hover:text-zinc-400 transition-colors">
                            {new Date(item.start * 1000).toISOString().substr(14, 5)}
                        </span>
                    </div>

                    {langOrder.map(lang => renderContent(lang))}
                </div>
            );
        });

        const ScriptList = React.memo(({ 
            scripts, baseLang, activeIndex, onItemClick, searchQuery, 
            fontSizes, showPinyin, autoScroll, langOrder, visibleLangs 
        }) => {
            const baseScript = scripts[baseLang];
            if (!baseScript || baseScript.length === 0) {
                return <div className="p-10 text-center text-slate-500 dark:text-zinc-500 text-sm">ÏÑ†ÌÉùÌïú Í∏∞Ï§Ä Ïñ∏Ïñ¥Ïùò Ïä§ÌÅ¨Î¶ΩÌä∏Í∞Ä ÏóÜÏäµÎãàÎã§.</div>;
            }

            let itemsToRender = baseScript;
            if (searchQuery.trim() !== '') {
                const query = searchQuery.toLowerCase();
                itemsToRender = baseScript.filter(item => item.text.toLowerCase().includes(query));
            }

            if (itemsToRender.length === 0) return <div className="p-10 text-center text-slate-500 dark:text-zinc-500 text-sm">Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.</div>;

            return (
                <div className="flex-1 overflow-y-auto p-2 custom-scrollbar bg-lightbg dark:bg-darkbg select-text">
                    {itemsToRender.map((item, idx) => {
                        const originalIdx = scripts[baseLang].indexOf(item); 
                        const isActive = activeIndex === originalIdx;

                        const nextItem = scripts[baseLang][originalIdx + 1];
                        const endTime = item.end || (nextItem ? nextItem.start : (item.start + 10));

                        const koContent = baseLang === 'ko' ? item : getMatchingContent(scripts.ko, item.start, endTime);
                        const enContent = baseLang === 'en' ? item : getMatchingContent(scripts.en, item.start, endTime);
                        const cnContent = baseLang === 'cn' ? item : getMatchingContent(scripts.cn, item.start, endTime);

                        return (
                            <ScriptItem 
                                key={originalIdx}
                                item={item}
                                idx={originalIdx}
                                isActive={isActive}
                                onClick={onItemClick}
                                baseLang={baseLang}
                                fontSizes={fontSizes}
                                showPinyin={showPinyin}
                                koContent={koContent}
                                cnContent={cnContent}
                                enContent={enContent}
                                autoScroll={autoScroll}
                                searchQuery={searchQuery}
                                langOrder={langOrder}
                                visibleLangs={visibleLangs}
                            />
                        );
                    })}
                </div>
            );
        });

        const RAW_URL_CLEANER = (url) => url.replace('/refs/heads/', '/');
        const USER_GITHUB_BASE = "https://raw.githubusercontent.com/MultipePlayer/whateveryouwant/main/";
        const INDEX_URL = RAW_URL_CLEANER(`${USER_GITHUB_BASE}jw_data_index.json`);

        const App = () => {
            const [allItems, setAllItems] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            
            // Search States
            const [searchQuery, setSearchQuery] = useState('');
            // [NEW] Debounced Query for Performance
            const [debouncedSearchQuery, setDebouncedSearchQuery] = useState('');
            const [searchResults, setSearchResults] = useState([]);
            const [showSearchResults, setShowSearchResults] = useState(false);
            const [searchScope, setSearchScope] = useState('all'); 
            const [showScopeMenu, setShowScopeMenu] = useState(false); 
            const [expandedSearch, setExpandedSearch] = useState(false); 

            const [selectedItem, setSelectedItem] = useState(null);
            
            const [audioLang, setAudioLang] = useState('ko');       
            const [baseLang, setBaseLang] = useState('ko');       
            
            const [subtitleModes, setSubtitleModes] = useState(new Set(['ko'])); 
            
            const [videoError, setVideoError] = useState(null);
            const [toastMessage, setToastMessage] = useState(null);
            const [showPlayerSettings, setShowPlayerSettings] = useState(false);
            const [showRightSettings, setShowRightSettings] = useState(false);

            const [currentTime, setCurrentTime] = useState(0);
            const [duration, setDuration] = useState(0);
            const [isPlaying, setIsPlaying] = useState(false);
            const [loopMode, setLoopMode] = useState(false); 
            
            const [playbackSpeed, setPlaybackSpeed] = useState(1.0);
            const [autoScroll, setAutoScroll] = useState(true);

            const [selectedText, setSelectedText] = useState('');
            const [selectionPos, setSelectionPos] = useState({ x: 0, y: 0 });
            
            const [fontSizes, setFontSizes] = useState({ ko: 18, en: 18, cn: 18 });
            const [showPinyin, setShowPinyin] = useState(true); // Always true, no toggle
            const [scriptSearchQuery, setScriptSearchQuery] = useState('');

            // Language Order and Visibility States
            const [langOrder, setLangOrder] = useState(['ko', 'en', 'cn']);
            const [visibleLangs, setVisibleLangs] = useState({ ko: true, en: true, cn: true });
            
            // Theme State
            const [theme, setTheme] = useState('dark');

            const videoRef = useRef(null);
            const scriptContainerRef = useRef(null); 
            const scopeMenuRef = useRef(null);

            // [MODIFIED] Language Labels (Korean)
            const langLabels = { ko: 'ÌïúÍµ≠Ïñ¥', en: 'ÏòÅÏñ¥', cn: 'Ï§ëÍµ≠Ïñ¥' };
            const speedOptions = [0.5, 0.75, 0.8, 0.9, 1.0, 1.2, 1.5];

            // Apply Theme
            useEffect(() => {
                const root = document.documentElement;
                if (theme === 'dark') {
                    root.classList.add('dark');
                } else {
                    root.classList.remove('dark');
                }
            }, [theme]);

            const showToast = (msg) => {
                setToastMessage(msg);
                setTimeout(() => setToastMessage(null), 3000);
            };

            const loadData = async () => {
                setLoading(true); setError(null);
                try {
                    const response = await fetch(INDEX_URL, { cache: 'no-cache' });
                    if (!response.ok) throw new Error("Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.");
                    const index = await response.json();
                    const allLoaded = await Promise.all(
                        index.map(async (fileName) => {
                            try {
                                const fileUrl = RAW_URL_CLEANER(`${USER_GITHUB_BASE}${fileName}`);
                                const res = await fetch(fileUrl);
                                if (res.ok) {
                                    const items = await res.json();
                                    return items.map(item => ({
                                        ...item,
                                        _searchIndex: JSON.stringify({ t: item.title, u: item.url, s: item.scripts }).toLowerCase()
                                    }));
                                }
                                return [];
                            } catch (e) { return []; }
                        })
                    );
                    setAllItems(allLoaded.flat().filter(item => item && item.natural_key));
                } catch (err) {
                    setError(`Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ïã§Ìå®: ${err.message}`);
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => { loadData(); }, []);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (scopeMenuRef.current && !scopeMenuRef.current.contains(event.target)) {
                        setShowScopeMenu(false);
                    }
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, []);

            // [NEW] Debounce Input (0.3Ï¥à)
            useEffect(() => {
                const handler = setTimeout(() => {
                    setDebouncedSearchQuery(searchQuery);
                }, 300); // 300ms debounce
                return () => clearTimeout(handler);
            }, [searchQuery]);

            // [NEW] Advanced Search Logic (Hit Count & Sort) with Debounce
            useEffect(() => {
                const query = debouncedSearchQuery.trim().toLowerCase();
                if (query === '') {
                    setSearchResults([]);
                    setShowSearchResults(false);
                    setExpandedSearch(false);
                } else {
                    // 1. Calculate Hits & Match Info
                    const resultsWithHits = allItems.map(item => {
                        let hits = 0;
                        let matchedScriptPreview = null;
                        let isMatch = false;

                        // Title Match
                        if (searchScope === 'all' || searchScope === 'title') {
                             if (item.title && item.title.toLowerCase().includes(query)) {
                                 isMatch = true;
                                 // Title match doesn't increment hit count (as per request for frequency display)
                             }
                        }

                        // Script Match & Count
                        if (searchScope === 'all' || searchScope === 'script') {
                            if (item.scripts) {
                                ['ko', 'en', 'cn'].forEach(lang => {
                                    item.scripts[lang]?.forEach(s => {
                                        if (s.text && s.text.toLowerCase().includes(query)) {
                                            const countInLine = (s.text.toLowerCase().split(query).length - 1);
                                            if (countInLine > 0) {
                                                isMatch = true;
                                                hits += countInLine;
                                                if (!matchedScriptPreview) matchedScriptPreview = s.text;
                                            }
                                        }
                                    });
                                });
                            }
                        }

                        return { ...item, _hitCount: hits, _matchedPreview: matchedScriptPreview, _isMatch: isMatch };
                    });

                    // 2. Filter
                    const filtered = resultsWithHits.filter(item => item._isMatch);

                    // 3. Sort (Hits Descending, then Title length/accuracy if needed)
                    filtered.sort((a, b) => b._hitCount - a._hitCount);

                    setSearchResults(filtered);
                    setShowSearchResults(true);
                    setExpandedSearch(false);
                }
            }, [debouncedSearchQuery, allItems, searchScope]);

            useEffect(() => {
                if (videoRef.current) {
                    videoRef.current.playbackRate = playbackSpeed;
                }
            }, [playbackSpeed]);

            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) return;
                    const key = e.key.toLowerCase();
                    switch(key) {
                        case ' ': 
                        case 'k': e.preventDefault(); togglePlay(); break;
                        case 'arrowleft': if (videoRef.current) { videoRef.current.currentTime = Math.max(0, videoRef.current.currentTime - 5); setCurrentTime(videoRef.current.currentTime); showToast("‚è© 5Ï¥à Îí§Î°ú"); } break;
                        case 'arrowright': if (videoRef.current) { videoRef.current.currentTime = Math.min(duration, videoRef.current.currentTime + 5); setCurrentTime(videoRef.current.currentTime); showToast("‚è© 5Ï¥à ÏïûÏúºÎ°ú"); } break;
                        case '[': setPlaybackSpeed(prev => { const idx = speedOptions.indexOf(prev); const newSpeed = idx > 0 ? speedOptions[idx - 1] : prev; showToast(`ÏÜçÎèÑ: ${newSpeed}x`); return newSpeed; }); break;
                        case ']': setPlaybackSpeed(prev => { const idx = speedOptions.indexOf(prev); const newSpeed = idx < speedOptions.length - 1 ? speedOptions[idx + 1] : prev; showToast(`ÏÜçÎèÑ: ${newSpeed}x`); return newSpeed; }); break;
                        case 'l': setLoopMode(prev => { showToast(prev ? "Î£®ÌîÑ Ìï¥Ï†ú" : "A-B Î£®ÌîÑ ÏºúÏßê"); return !prev; }); break;
                        case 's': setAutoScroll(prev => { showToast(prev ? "ÏûêÎèô Ïä§ÌÅ¨Î°§ Í∫ºÏßê" : "ÏûêÎèô Ïä§ÌÅ¨Î°§ ÏºúÏßê"); return !prev; }); break;
                    }
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [duration, speedOptions]);

            const selectVideo = useCallback((item, initialLang = 'ko') => {
                setSelectedItem(item);
                setSearchQuery('');
                setShowSearchResults(false);
                setScriptSearchQuery('');
                setCurrentTime(0);
                setIsPlaying(true);
                setVideoError(null);
                setAudioLang(initialLang);
                setBaseLang(initialLang);
                setSubtitleModes(new Set([initialLang === 'ko' ? 'en' : 'ko']));
                setShowPlayerSettings(false);
            }, []);

            const handleSearchSubmit = (e) => {
                e.preventDefault();
                if (searchResults.length > 0) { selectVideo(searchResults[0]); return; }
                
                let decodedQuery = searchQuery;
                try { decodedQuery = decodeURIComponent(searchQuery); } catch (e) {}

                if (decodedQuery.includes('jw.org')) {
                    const pubMatch = decodedQuery.match(/(pub-[a-zA-Z0-9-_]+)/);
                    const keyword = pubMatch?.[1];
                    let targetLang = 'ko';
                    if (decodedQuery.includes('/cmn-hans/') || decodedQuery.includes('wtlocale=CHS')) targetLang = 'cn';
                    else if (decodedQuery.includes('/en/') || decodedQuery.includes('wtlocale=E')) targetLang = 'en';

                    if (keyword) {
                        const hit = allItems.find(item => item._searchIndex.includes(keyword.toLowerCase()));
                        if (hit) { selectVideo(hit, targetLang); showToast(`${langLabels[targetLang]} Î™®ÎìúÎ°ú ÏÑ§Ï†ï`); return; }
                    }
                    setVideoError("DBÏóê ÏóÜÎäî ÏòÅÏÉÅÏûÖÎãàÎã§.");
                    setSelectedItem({ title: "Unknown", isExternal: true, url: "", scripts: { ko: [], en: [], cn: [] } });
                    return;
                }
                if (searchQuery.startsWith('http')) {
                    selectVideo({
                        title: "Ïô∏Î∂Ä ÎßÅÌÅ¨ ÏòÅÏÉÅ",
                        url: searchQuery,
                        scripts: { ko: [], en: [], cn: [] },
                        natural_key: "ext_" + Date.now(),
                        isExternal: true
                    });
                }
            };

            const getVideoUrl = (item, lang) => {
                if (!item) return '';
                if (item.isExternal) return item.url;
                const map = { ko: ['ko','KR','KO'], en: ['en','E','EN'], cn: ['cn','CHS','CN'] };
                const keys = map[lang] || [lang];
                if (item.video_urls) { for (const k of keys) if (item.video_urls[k]) return item.video_urls[k]; }
                if (item.videos) { for (const k of keys) if (item.videos[k]) return item.videos[k]; }
                return item.url;
            };

            const currentVideoUrl = useMemo(() => getVideoUrl(selectedItem, audioLang), [selectedItem, audioLang]);

            useEffect(() => {
                if (!selectedItem || selectedItem.isExternal) return;
                if (audioLang !== 'ko') {
                    const defUrl = selectedItem.url;
                    const curUrl = getVideoUrl(selectedItem, audioLang);
                    if (curUrl === defUrl && !selectedItem.video_urls?.[audioLang]) {
                        showToast(`'${langLabels[audioLang]}' ÏùåÏÑ± ÏóÜÏùå. Í∏∞Î≥∏ Ïñ∏Ïñ¥Î°ú Ïû¨ÏÉùÌï©ÎãàÎã§.`);
                    }
                }
            }, [audioLang, selectedItem]);

            const activeIndices = useMemo(() => {
                if (!selectedItem || selectedItem.isExternal || !selectedItem.scripts) return { base: -1 };
                const baseScript = selectedItem.scripts[baseLang];
                if (!baseScript || baseScript.length === 0) return { base: -1 };
                
                const baseIdx = findIndexByTime(baseScript, currentTime);
                
                if (baseIdx !== -1) {
                    const item = baseScript[baseIdx];
                    const nextItem = baseScript[baseIdx + 1];
                    const endTime = item.end || (nextItem ? nextItem.start : item.start + 10);
                    if (currentTime > endTime + 0.2) {
                        return { base: -1 }; 
                    }
                }
                
                return { base: baseIdx };
            }, [currentTime, selectedItem, baseLang]);

            const onTimeUpdate = useCallback(() => {
                if (!videoRef.current) return;
                const v = videoRef.current;
                setCurrentTime(v.currentTime);

                if (loopMode && selectedItem?.scripts?.[baseLang]) {
                    const script = selectedItem.scripts[baseLang];
                    const idx = findIndexByTime(script, v.currentTime);
                    if (idx !== -1) {
                        const currentItem = script[idx];
                        const endTime = currentItem.end || (script[idx+1] ? script[idx+1].start : v.duration);
                        if (v.currentTime >= endTime - 0.2) v.currentTime = currentItem.start;
                    }
                }
            }, [selectedItem, baseLang, loopMode]);

            const onLoadedData = () => {
                if (videoRef.current) {
                    videoRef.current.playbackRate = playbackSpeed;
                    Array.from(videoRef.current.textTracks).forEach(t => t.mode = 'disabled');
                    if (currentTime > 0) {
                        videoRef.current.currentTime = currentTime;
                        if (isPlaying) {
                            videoRef.current.play().catch(e => {
                                if(e.name !== 'AbortError') console.log("Play interrupted");
                                setIsPlaying(false);
                            });
                        }
                    }
                    setDuration(videoRef.current.duration);
                    setVideoError(null);
                }
            };

            const togglePlay = () => {
                if (!videoRef.current) return;
                if (videoRef.current.paused) {
                    videoRef.current.play().catch(e => {
                        if(e.name !== 'AbortError') console.log("Play failed", e);
                        setIsPlaying(false);
                    });
                } else {
                    videoRef.current.pause();
                }
            };

            const handleScriptClick = useCallback((time) => {
                if (videoRef.current) videoRef.current.currentTime = time;
            }, []);

            const toggleSubtitleMode = (langId) => {
                const newModes = new Set(subtitleModes);
                if (newModes.has(langId)) newModes.delete(langId); else newModes.add(langId);
                setSubtitleModes(newModes);
            };

            const moveLang = (index, direction) => {
                const newOrder = [...langOrder];
                if (direction === 'up' && index > 0) {
                    [newOrder[index], newOrder[index - 1]] = [newOrder[index - 1], newOrder[index]];
                } else if (direction === 'down' && index < newOrder.length - 1) {
                    [newOrder[index], newOrder[index + 1]] = [newOrder[index + 1], newOrder[index]];
                }
                setLangOrder(newOrder);
            };

            const toggleLangVisibility = (langId) => {
                setVisibleLangs(prev => ({ ...prev, [langId]: !prev[langId] }));
            };

            useEffect(() => {
                if (scriptContainerRef.current) {
                    scriptContainerRef.current.scrollTo({ top: 0, behavior: 'smooth' });
                }
                setLangOrder(prev => {
                    const newOrder = [baseLang, ...prev.filter(l => l !== baseLang)];
                    return newOrder;
                });
            }, [baseLang]);


            if (loading) return <div className="flex items-center justify-center h-full bg-lightbg dark:bg-darkbg text-slate-500 dark:text-zinc-500"><div className="animate-spin rounded-full h-8 w-8 border-2 border-slate-600 dark:border-zinc-600 border-t-slate-200 dark:border-t-zinc-200"></div></div>;
            if (error) return <div className="flex items-center justify-center h-full text-red-500 dark:text-red-400">{error}</div>;

            return (
                <div className="flex flex-col h-full overflow-hidden select-none bg-lightbg dark:bg-darkbg transition-colors duration-300">
                    {/* Header */}
                    <header className="h-16 flex items-center justify-between px-4 shrink-0 border-b border-slate-200 dark:border-zinc-800 bg-lightbg/90 dark:bg-darkbg/90 backdrop-blur-md z-30 gap-4">
                        <div className="flex items-center gap-2 cursor-pointer shrink-0" onClick={() => { setSelectedItem(null); setIsPlaying(false); }}>
                            <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold text-lg">J</div>
                            <span className="font-bold text-base tracking-tight hidden sm:block text-slate-700 dark:text-zinc-200">Language Player</span>
                        </div>
                        
                        {/* Mobile-Friendly Search Bar */}
                        <form onSubmit={handleSearchSubmit} className="flex-1 max-w-2xl mx-auto relative group">
                            {/* [MODIFIED] Added z-[60] to the container div to ensure it's higher than search results (z-50) */}
                            <div className="relative flex items-center bg-lightpanel dark:bg-panel rounded-full border border-slate-300 dark:border-zinc-600 focus-within:border-blue-500 transition-colors h-11 shadow-sm dark:shadow-lg w-full z-[60]">
                                
                                <div className="relative z-20" ref={scopeMenuRef}>
                                    <button 
                                        type="button" 
                                        onClick={() => setShowScopeMenu(!showScopeMenu)}
                                        className="flex items-center gap-1.5 px-3 h-full text-xs font-bold text-slate-600 dark:text-zinc-300 hover:text-slate-900 dark:hover:text-white transition-colors whitespace-nowrap"
                                    >
                                        <span>
                                            {searchScope === 'all' ? 'Ï†ÑÏ≤¥' : 
                                             searchScope === 'title' ? 'Ï†úÎ™©' : 'ÏûêÎßâ'}
                                        </span>
                                        <Icon name="chevronDown" className={`w-3 h-3 transition-transform ${showScopeMenu ? 'rotate-180' : ''}`} />
                                    </button>
                                    
                                    {showScopeMenu && (
                                        <div className="absolute top-full left-0 mt-2 w-24 bg-lightpanel dark:bg-panel border border-slate-200 dark:border-zinc-700 rounded-lg shadow-xl py-1 z-[100] animate-slide-down overflow-hidden">
                                            {[ { id: 'all', label: 'Ï†ÑÏ≤¥' }, { id: 'title', label: 'Ï†úÎ™©' }, { id: 'script', label: 'ÏûêÎßâ' } ].map(opt => (
                                                <button
                                                    key={opt.id}
                                                    type="button"
                                                    onClick={() => { setSearchScope(opt.id); setShowScopeMenu(false); }}
                                                    className={`w-full text-left px-3 py-2 text-xs font-medium hover:bg-slate-100 dark:hover:bg-zinc-700 transition-colors ${searchScope === opt.id ? 'text-blue-500 bg-slate-50 dark:bg-zinc-800' : 'text-slate-700 dark:text-zinc-300'}`}
                                                >
                                                    {opt.label}
                                                </button>
                                            ))}
                                        </div>
                                    )}
                                </div>
                                
                                <div className="w-px h-4 bg-slate-300 dark:bg-zinc-600 mx-1 z-20"></div>

                                <input 
                                    type="text" 
                                    placeholder="üîç ÏòÅÏÉÅ Ï†úÎ™©Ïù¥ÎÇò ÎÇ¥Ïö©ÏùÑ Í≤ÄÏÉâÌïòÏÑ∏Ïöî" 
                                    className="absolute inset-0 w-full h-full bg-transparent py-2 pl-24 pr-10 outline-none text-base text-slate-700 dark:text-zinc-200 placeholder-slate-400 dark:placeholder-zinc-500 rounded-full" 
                                    value={searchQuery} 
                                    onChange={(e) => setSearchQuery(e.target.value)}
                                    onFocus={() => { if(searchQuery) setShowSearchResults(true); }}
                                />
                                {searchQuery && (
                                    <button type="button" onClick={() => { setSearchQuery(''); setSearchResults([]); }} className="absolute right-3 z-20 text-slate-400 dark:text-zinc-500 hover:text-slate-600 dark:hover:text-zinc-300">
                                        <Icon name="x" className="w-4 h-4" />
                                    </button>
                                )}
                            </div>
                            
                            {/* Search Results */}
                            {showSearchResults && searchResults.length > 0 && (
                                <div className="absolute top-full left-0 right-0 mt-2 bg-lightpanel dark:bg-panel rounded-xl shadow-2xl border border-slate-200 dark:border-zinc-700 max-h-[60vh] overflow-y-auto custom-scrollbar z-50 p-2 max-w-[95vw] mx-auto">
                                    {(expandedSearch ? searchResults : searchResults.slice(0, 5)).map(item => (
                                        <button key={item.natural_key} type="button" onClick={() => selectVideo(item)} className="w-full text-left px-4 py-3 hover:bg-slate-100 dark:hover:bg-zinc-700 rounded-lg group transition-colors flex items-center justify-between border-b border-slate-100 dark:border-zinc-700/50 last:border-0">
                                            <div className="flex-1 min-w-0 pr-3">
                                                <div className="font-medium text-sm text-slate-700 dark:text-zinc-200 group-hover:text-blue-500 dark:group-hover:text-blue-400 truncate flex items-center">
                                                    <span className="truncate">
                                                        <HighlightText text={item.title} highlight={searchQuery} />
                                                    </span>
                                                    {item._hitCount > 0 && (
                                                        <span className="ml-2 text-[10px] text-blue-500 font-bold bg-blue-50 dark:bg-blue-900/30 px-1.5 py-0.5 rounded-full whitespace-nowrap">
                                                            {item._hitCount}Ìöå
                                                        </span>
                                                    )}
                                                </div>
                                                {searchQuery && !item.title.toLowerCase().includes(searchQuery.toLowerCase()) && item._matchedPreview && (
                                                    <div className="text-[11px] text-slate-500 dark:text-zinc-500 truncate mt-0.5">
                                                        Match: <HighlightText text={item._matchedPreview} highlight={searchQuery} />
                                                    </div>
                                                )}
                                            </div>
                                            <span className="text-[10px] text-slate-500 dark:text-zinc-500 font-medium px-2 py-1 rounded bg-slate-200 dark:bg-zinc-800 shrink-0">Ïû¨ÏÉù</span>
                                        </button>
                                    ))}
                                    {searchResults.length > 5 && !expandedSearch && (
                                        <button 
                                            type="button" 
                                            onClick={() => setExpandedSearch(true)}
                                            className="w-full text-center py-2.5 text-xs font-bold text-blue-500 dark:text-blue-400 hover:text-blue-600 dark:hover:text-blue-300 hover:bg-slate-100 dark:hover:bg-zinc-700 rounded-lg mt-1"
                                        >
                                            ÎçîÎ≥¥Í∏∞ ({searchResults.length - 5}Í∞ú Îçî ÏûàÏùå)
                                        </button>
                                    )}
                                </div>
                            )}
                        </form>
                        
                        {/* Theme Toggle Button */}
                        <button 
                            onClick={() => setTheme(theme === 'dark' ? 'light' : 'dark')}
                            className="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-zinc-800 text-slate-600 dark:text-zinc-400 transition-colors shrink-0"
                        >
                            <Icon name={theme === 'dark' ? 'sun' : 'moon'} className="w-5 h-5" />
                        </button>
                    </header>

                    {/* [MODIFIED] Mobile Layout: Video Only on Mobile, Row on Desktop */}
                    <main className="flex-1 flex flex-col md:flex-row overflow-hidden relative">
                        {/* Video Player */}
                        <div className="w-full h-full md:w-[40%] flex flex-col min-w-0 bg-black relative group border-r-0 md:border-r border-slate-300 dark:border-zinc-800">
                            {!selectedItem ? (
                                <div className="flex-1 flex flex-col items-center justify-center bg-slate-50 dark:bg-panel text-slate-400 dark:text-zinc-500 gap-4">
                                    <Icon name="play" className="w-16 h-16 opacity-20" />
                                    <p className="text-base font-medium text-slate-500 dark:text-zinc-400">ÏòÅÏÉÅÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî</p>
                                </div>
                            ) : (
                                <>
                                    <div className="flex-1 relative flex items-center justify-center bg-black cursor-pointer w-full min-h-0" onClick={togglePlay}>
                                        <video 
                                            key={currentVideoUrl} 
                                            ref={videoRef} 
                                            src={currentVideoUrl} 
                                            className="w-full h-full object-contain" 
                                            onTimeUpdate={onTimeUpdate}
                                            onLoadedData={onLoadedData} 
                                            onPlay={() => setIsPlaying(true)} 
                                            onPause={() => setIsPlaying(false)} 
                                            onError={(e) => {
                                                console.error(e.currentTarget.error);
                                                setVideoError("ÏòÅÏÉÅÏùÑ Ïû¨ÏÉùÌï† Ïàò ÏóÜÏäµÎãàÎã§.");
                                                setIsPlaying(false);
                                            }}
                                            playsInline autoPlay 
                                        />
                                        
                                        {!isPlaying && !videoError && (
                                            <div className="absolute inset-0 flex items-center justify-center bg-black/20 pointer-events-none fade-in z-10">
                                                <div className="w-20 h-20 bg-white/10 backdrop-blur-sm rounded-full flex items-center justify-center text-white border border-white/20 shadow-2xl">
                                                    <Icon name="play" className="w-10 h-10 ml-1 fill-current" />
                                                </div>
                                            </div>
                                        )}

                                        {/* Overlay Subtitles: [MODIFIED] Fixed Font Size */}
                                        {!selectedItem.isExternal && !videoError && selectedItem.scripts && activeIndices.base !== -1 && (
                                            <div className="absolute bottom-6 left-0 right-0 px-4 text-center pointer-events-none flex flex-col items-center gap-2">
                                                <div className="inline-block bg-black/70 backdrop-blur-md px-6 py-4 rounded-xl shadow-lg max-w-full">
                                                     {/* Base Lang */}
                                                    <div 
                                                        className={`text-white font-semibold leading-relaxed drop-shadow-sm transition-all duration-300 ${baseLang === 'cn' ? 'font-chinese-serif tracking-wide' : ''}`}
                                                        style={{ fontSize: '16.5px' }} // Fixed size
                                                    >
                                                        {selectedItem.scripts[baseLang]?.[activeIndices.base]?.text}
                                                    </div>
                                                    
                                                    {/* Other Langs */}
                                                    {Array.from(subtitleModes).map(mode => {
                                                        if (mode === baseLang) return null; 
                                                        
                                                        const baseItem = selectedItem.scripts[baseLang]?.[activeIndices.base];
                                                        if (!baseItem) return null;
                                                        
                                                        const endTime = baseItem.end || (selectedItem.scripts[baseLang][activeIndices.base+1] ? selectedItem.scripts[baseLang][activeIndices.base+1].start : (baseItem.start + 10));
                                                        
                                                        const matched = getMatchingContent(selectedItem.scripts[mode], baseItem.start, endTime);
                                                        
                                                        if (!matched) return null;

                                                        return (
                                                            <div 
                                                                key={mode} 
                                                                className={`text-zinc-200 mt-2 font-medium border-t border-white/10 pt-2 flex flex-col-reverse items-center ${mode === 'cn' ? 'font-chinese-serif' : ''}`}
                                                                style={{ fontSize: '16.5px' }} // Fixed size
                                                            >
                                                                    {matched.text}
                                                                    {/* Overlay Pinyin Support */}
                                                                    {mode === 'cn' && showPinyin && matched.pinyin && (
                                                                        <div className="text-sm text-blue-300 mb-1">{matched.pinyin}</div>
                                                                    )}
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        )}

                                        {toastMessage && (
                                            <div className="absolute top-6 left-1/2 -translate-x-1/2 bg-zinc-800/90 text-white px-5 py-2.5 rounded-full shadow-lg z-50 text-sm font-semibold backdrop-blur-md toast-enter flex items-center gap-2 border border-zinc-700">
                                                <Icon name="alert" className="w-4 h-4 text-yellow-400" /> {toastMessage}
                                            </div>
                                        )}
                                        
                                        {videoError && (
                                            <div className="absolute inset-0 flex items-center justify-center bg-zinc-900 z-20">
                                                <div className="text-center">
                                                    <Icon name="alert" className="w-12 h-12 text-red-500 mx-auto mb-3 opacity-80" />
                                                    <p className="text-zinc-300 text-base">{videoError}</p>
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    {/* CONTROLS */}
                                    <div className="bg-lightpanel dark:bg-panel border-t border-slate-200 dark:border-zinc-800 p-4 shrink-0 z-20">
                                        <div className="flex items-center gap-4 text-xs font-mono font-medium text-slate-500 dark:text-zinc-400 mb-3">
                                            <span>{new Date(currentTime * 1000).toISOString().substr(14, 5)}</span>
                                            <input type="range" min="0" max={duration || 100} value={currentTime} onChange={(e) => { const t = parseFloat(e.target.value); if(videoRef.current) videoRef.current.currentTime = t; setCurrentTime(t); }} className="flex-1 h-1.5 bg-slate-300 dark:bg-zinc-700 rounded-lg appearance-none cursor-pointer accent-blue-500" style={{ backgroundSize: `${(currentTime/duration)*100}% 100%` }} />
                                            <span>{new Date((duration || 0) * 1000).toISOString().substr(14, 5)}</span>
                                        </div>

                                        <div className="flex flex-wrap items-center justify-between gap-3">
                                            {!selectedItem.isExternal && (
                                                <div className="flex items-center gap-2 overflow-x-auto no-scrollbar">
                                                    {/* Audio Icon Label */}
                                                    <div className="flex items-center gap-1 text-slate-500 dark:text-zinc-500">
                                                        <Icon name="headphone" className="w-4 h-4" />
                                                        <span className="text-[10px] font-bold">ÏùåÏÑ±</span>
                                                    </div>
                                                    <div className="h-4 w-px bg-slate-300 dark:bg-zinc-700 mx-1"></div>
                                                    {/* Language Buttons */}
                                                    {[{ id: 'ko', label: 'ÌïúÍµ≠Ïñ¥' }, { id: 'en', label: 'ÏòÅÏñ¥' }, { id: 'cn', label: 'Ï§ëÍµ≠Ïñ¥' }].map(l => (
                                                        <button 
                                                            key={l.id} 
                                                            onClick={() => setAudioLang(l.id)} 
                                                            className={`px-3 py-1.5 text-xs font-bold rounded transition-all whitespace-nowrap ${audioLang === l.id ? 'bg-slate-200 dark:bg-zinc-200 text-slate-900 dark:text-black' : 'text-slate-500 dark:text-zinc-500 hover:text-slate-800 dark:hover:text-zinc-300 bg-slate-100 dark:bg-zinc-800'}`}
                                                        >
                                                                {l.label}
                                                        </button>
                                                    ))}
                                                </div>
                                            )}

                                            <div className="flex items-center justify-center flex-1">
                                                 <button 
                                                    onClick={() => setLoopMode(!loopMode)} 
                                                    className={`flex items-center gap-2 px-4 py-2 rounded-full transition-all ${loopMode ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/50' : 'bg-slate-200 dark:bg-zinc-800 text-slate-600 dark:text-zinc-400 hover:bg-slate-300 dark:hover:bg-zinc-700'}`}
                                                >
                                                    <Icon name="repeat" className="w-4 h-4" />
                                                    <span className="text-xs font-bold">{loopMode ? 'Î£®ÌîÑ On' : 'Î£®ÌîÑ Off'}</span>
                                                </button>
                                            </div>

                                            <div className="relative">
                                                <button 
                                                    onClick={() => setShowPlayerSettings(!showPlayerSettings)} 
                                                    className={`p-2.5 rounded-full transition-colors flex items-center gap-1.5 ${showPlayerSettings ? 'bg-slate-200 dark:bg-zinc-800 text-blue-500 dark:text-blue-400' : 'text-slate-500 dark:text-zinc-400 hover:text-slate-800 dark:hover:text-zinc-200'}`}
                                                >
                                                    <span className="text-xs font-bold">{playbackSpeed}x</span>
                                                    <Icon name="settings" className="w-5 h-5" />
                                                </button>

                                                {showPlayerSettings && (
                                                    <div className="absolute bottom-full right-0 mb-4 bg-lightpanel dark:bg-panel border border-slate-200 dark:border-zinc-700 rounded-xl shadow-2xl p-5 w-60 popup-enter z-50 max-w-[90vw]">
                                                        <div className="mb-5">
                                                            <div className="text-[11px] font-bold text-slate-500 dark:text-zinc-500 uppercase px-1 mb-2">Î∞∞ÏÜç</div>
                                                            <div className="grid grid-cols-4 gap-1.5">
                                                                {speedOptions.map(rate => (
                                                                    <button 
                                                                        key={rate} 
                                                                        onClick={() => setPlaybackSpeed(rate)}
                                                                        className={`text-[11px] font-bold py-2 rounded transition-colors ${playbackSpeed === rate ? 'bg-blue-600 text-white' : 'bg-slate-100 dark:bg-zinc-800 text-slate-600 dark:text-zinc-400 hover:bg-slate-200 dark:hover:bg-zinc-700'}`}
                                                                    >
                                                                                {rate}
                                                                    </button>
                                                                ))}
                                                            </div>
                                                        </div>

                                                        {!selectedItem.isExternal && (
                                                            <div>
                                                                <div className="text-[11px] font-bold text-slate-500 dark:text-zinc-500 uppercase px-1 mb-2">ÏûêÎßâ Î™®Îìú (Îã§Ï§ë ÏÑ†ÌÉù)</div>
                                                                <div className="flex flex-col gap-1.5">
                                                                    {[{ id: 'ko', label: 'ÌïúÍµ≠Ïñ¥' }, { id: 'en', label: 'ÏòÅÏñ¥' }, { id: 'cn', label: 'Ï§ëÍµ≠Ïñ¥' }].map(l => {
                                                                        const isActive = subtitleModes.has(l.id);
                                                                        return (
                                                                            <button 
                                                                                key={l.id} 
                                                                                onClick={() => toggleSubtitleMode(l.id)} 
                                                                                className={`flex items-center justify-between px-3 py-2 text-xs font-bold rounded transition-all ${isActive ? 'bg-slate-200 dark:bg-zinc-700 text-blue-600 dark:text-blue-400' : 'text-slate-500 dark:text-zinc-500 hover:bg-slate-100 dark:hover:bg-zinc-800'}`}
                                                                            >
                                                                                <span>{l.label}</span>
                                                                                {isActive && <Icon name="check" className="w-3.5 h-3.5" />}
                                                                            </button>
                                                                        );
                                                                    })}
                                                                </div>
                                                            </div>
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                </>
                            )}
                        </div>

                        {/* Script Panel - HIDDEN ON MOBILE (md:flex) */}
                        <div className="hidden md:flex md:w-[60%] md:h-full border-l-0 md:border-l border-slate-200 dark:border-zinc-800 bg-lightbg dark:bg-darkbg flex-col shadow-xl z-20 shrink-0 min-h-0">
                            {/* Script Header */}
                            <div className="p-4 border-b border-slate-200 dark:border-zinc-800 bg-lightbg/95 dark:bg-darkbg/95 backdrop-blur-sm space-y-3 shrink-0">
                                {selectedItem && !selectedItem.isExternal ? (
                                    <>
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center gap-3">
                                                <span className="text-[11px] font-bold text-slate-500 dark:text-zinc-500 uppercase flex items-center gap-1.5" title="Ïñ∏Ïñ¥Î≥Ñ Ïñ¥ÏàúÏù¥ Îã§Î¶ÖÎãàÎã§. ÌïôÏäµ Í∏∞Ï§Ä Ïñ∏Ïñ¥Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.">
                                                    <Icon name="list" className="w-3.5 h-3.5" /> Í∏∞Ï§Ä Ïñ∏Ïñ¥
                                                    <button onClick={() => showToast("Ïñ∏Ïñ¥Î≥Ñ Ïñ¥ÏàúÏù¥ Îã§Î¶ÖÎãàÎã§. ÌïôÏäµ Í∏∞Ï§Ä Ïñ∏Ïñ¥Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.")} className="md:hidden ml-1 text-slate-600 dark:text-zinc-600"><Icon name="info" className="w-3 h-3" /></button>
                                                </span>
                                                <div className="flex bg-slate-200 dark:bg-zinc-900 rounded-lg p-0.5">
                                                    {/* Language Labels */}
                                                    {[{ id: 'ko', label: 'ÌïúÍµ≠Ïñ¥' }, { id: 'en', label: 'ÏòÅÏñ¥' }, { id: 'cn', label: 'Ï§ëÍµ≠Ïñ¥' }].map(l => (
                                                        <button 
                                                            key={l.id} 
                                                            onClick={() => { 
                                                                setBaseLang(l.id); 
                                                                setSubtitleModes(new Set([l.id === 'ko' ? 'en' : 'ko']));
                                                            }} 
                                                            className={`px-3 py-1.5 text-xs font-bold rounded-md transition-all ${baseLang === l.id ? 'bg-slate-600 dark:bg-zinc-700 text-white shadow-sm' : 'text-slate-500 dark:text-zinc-500 hover:text-slate-800 dark:hover:text-zinc-300'}`}
                                                        >
                                                                {l.label}
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>

                                            <div className="flex items-center gap-2">
                                                <button 
                                                    onClick={() => setAutoScroll(!autoScroll)}
                                                    className={`px-3 py-1.5 rounded-md text-[11px] font-bold border transition-colors ${autoScroll ? 'border-blue-500/50 text-blue-500 dark:text-blue-400 bg-blue-50 dark:bg-blue-500/10' : 'border-slate-300 dark:border-zinc-700 text-slate-500 dark:text-zinc-500'}`}
                                                >
                                                    {autoScroll ? 'On' : 'Off'}
                                                </button>
                                                <button onClick={() => setShowRightSettings(!showRightSettings)} className={`p-2 rounded-lg transition-colors ${showRightSettings ? 'bg-slate-200 dark:bg-zinc-800 text-blue-500 dark:text-blue-400' : 'text-slate-500 dark:text-zinc-500 hover:text-slate-800 dark:hover:text-zinc-300'}`}>
                                                    <Icon name="settings" className="w-4 h-4" />
                                                </button>
                                            </div>
                                        </div>

                                        {showRightSettings && (
                                            <div className="bg-lightpanel dark:bg-panel rounded-xl p-4 border border-slate-200 dark:border-zinc-700 animate-in slide-in-from-top-2 fade-in mb-2 shadow-lg max-w-[90vw]">
                                                {/* Removed Pinyin Toggle (Always On) */}
                                                
                                                <div className="space-y-1 border-b border-slate-200 dark:border-zinc-700 pb-3 mb-3"> 
                                                    {[{id:'ko', name:'ÌïúÍµ≠Ïñ¥'}, {id:'en', name:'ÏòÅÏñ¥'}, {id:'cn', name:'Ï§ëÍµ≠Ïñ¥'}].map(lang => (
                                                        <div key={lang.id} className="flex items-center gap-2">
                                                            <span className="text-[10px] font-bold text-slate-500 dark:text-zinc-500 w-6">{lang.name}</span>
                                                            <input 
                                                                type="range" 
                                                                min="12" 
                                                                max="22" 
                                                                step="1"
                                                                value={fontSizes[lang.id]} 
                                                                onChange={(e) => setFontSizes({...fontSizes, [lang.id]: Number(e.target.value)})} 
                                                                className="flex-1 h-1 bg-slate-300 dark:bg-zinc-700 rounded-lg appearance-none cursor-pointer" 
                                                            />
                                                            <span className="text-[10px] w-6 text-right text-slate-500 dark:text-zinc-500">{fontSizes[lang.id]}</span>
                                                        </div>
                                                    ))}
                                                </div>

                                                {/* Language Order & Visibility UI */}
                                                <div>
                                                    <div className="text-[10px] font-bold text-slate-500 dark:text-zinc-500 uppercase mb-2">Ïñ∏Ïñ¥ ÏàúÏÑú Î∞è ÌëúÏãú</div>
                                                    <div className="space-y-1">
                                                        {langOrder.map((langId, idx) => (
                                                            <div key={langId} className="flex items-center justify-between bg-slate-100 dark:bg-zinc-800 rounded px-2 py-1">
                                                                <span className="text-xs font-bold text-slate-700 dark:text-zinc-300 uppercase">{langLabels[langId]}</span>
                                                                <div className="flex items-center gap-1">
                                                                    <button onClick={() => toggleLangVisibility(langId)} className={`text-[9px] px-1.5 py-0.5 rounded ${visibleLangs[langId] ? 'bg-blue-100 dark:bg-blue-500/20 text-blue-600 dark:text-blue-400' : 'bg-slate-200 dark:bg-zinc-700 text-slate-500 dark:text-zinc-500'}`}>
                                                                        {visibleLangs[langId] ? 'On' : 'Off'}
                                                                    </button>
                                                                    <div className="flex flex-col">
                                                                        <button disabled={idx===0} onClick={() => moveLang(idx, 'up')} className="text-slate-400 dark:text-zinc-400 hover:text-slate-700 dark:hover:text-white disabled:opacity-30"><Icon name="arrowUp" className="w-3 h-3" /></button>
                                                                        <button disabled={idx===langOrder.length-1} onClick={() => moveLang(idx, 'down')} className="text-slate-400 dark:text-zinc-400 hover:text-slate-700 dark:hover:text-white disabled:opacity-30"><Icon name="arrowDown" className="w-3 h-3" /></button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            </div>
                                        )}

                                        <div className="relative">
                                            <Icon name="search" className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 dark:text-zinc-500" />
                                            <input 
                                                type="text" 
                                                placeholder="ÌòÑÏû¨ Ïä§ÌÅ¨Î¶ΩÌä∏ ÎÇ¥ Í≤ÄÏÉâ..." 
                                                className="w-full bg-slate-100 dark:bg-zinc-900 border border-transparent focus:border-blue-500 rounded-lg py-2.5 pl-10 pr-3 text-sm outline-none transition-all placeholder:text-slate-400 dark:placeholder:text-zinc-600 text-slate-700 dark:text-zinc-300"
                                                value={scriptSearchQuery}
                                                onChange={(e) => setScriptSearchQuery(e.target.value)}
                                            />
                                        </div>
                                    </>
                                ) : (
                                    <div className="text-center py-6 text-slate-500 dark:text-zinc-500 font-medium text-sm">Ïä§ÌÅ¨Î¶ΩÌä∏ ÏóÜÏùå</div>
                                )}
                            </div>

                            {/* Script List */}
                            {selectedItem && !selectedItem.isExternal && selectedItem.scripts && (
                                <div 
                                    className="flex-1 overflow-y-auto p-4 custom-scrollbar bg-lightbg dark:bg-darkbg select-text" 
                                    ref={scriptContainerRef}
                                    onMouseUp={() => {
                                        const selection = window.getSelection();
                                        const text = selection.toString().trim();
                                        if (text && text.length > 0) {
                                            const range = selection.getRangeAt(0);
                                            const rect = range.getBoundingClientRect();
                                            setSelectedText(text);
                                            setSelectionPos({ 
                                                x: Math.min(Math.max(rect.left + rect.width / 2, 20), window.innerWidth - 20), 
                                                y: rect.top 
                                            });
                                        } else {
                                            setSelectedText('');
                                        }
                                    }}
                                >
                                    <ScriptList 
                                        scripts={selectedItem.scripts}
                                        baseLang={baseLang}
                                        activeIndex={activeIndices.base}
                                        onItemClick={handleScriptClick}
                                        searchQuery={scriptSearchQuery}
                                        fontSizes={fontSizes}
                                        showPinyin={showPinyin}
                                        autoScroll={autoScroll}
                                        langOrder={langOrder}
                                        visibleLangs={visibleLangs}
                                    />
                                </div>
                            )}
                        </div>
                    </main>

                    {/* Dictionary Tooltip with Daum */}
                    {selectedText && (
                        <div 
                            className="fixed z-50 bg-white dark:bg-zinc-800 shadow-2xl rounded-xl p-2 flex gap-2 border border-slate-200 dark:border-zinc-700 animate-in zoom-in-95 duration-200" 
                            style={{ left: Math.min(window.innerWidth - 240, Math.max(10, selectionPos.x - 100)), top: selectionPos.y - 60 }}
                            onMouseUp={(e) => e.stopPropagation()} 
                            onMouseDown={(e) => e.stopPropagation()}
                        >
                            <a href={`https://dict.naver.com/search.nhn?query=${encodeURIComponent(selectedText)}`} target="_blank" onClick={(e) => e.stopPropagation()} className="px-3 py-2 bg-green-600 hover:bg-green-700 text-white text-xs font-bold rounded-lg transition-colors shadow-sm">ÎÑ§Ïù¥Î≤ÑÏÇ¨Ï†Ñ</a>
                            <a href={`https://dic.daum.net/search.do?q=${encodeURIComponent(selectedText)}`} target="_blank" onClick={(e) => e.stopPropagation()} className="px-3 py-2 bg-yellow-500 hover:bg-yellow-600 text-black text-xs font-bold rounded-lg transition-colors shadow-sm">Îã§ÏùåÏÇ¨Ï†Ñ</a>
                            <a href={`https://translate.google.com/?sl=auto&tl=ko&text=${encodeURIComponent(selectedText)}`} target="_blank" onClick={(e) => e.stopPropagation()} className="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold rounded-lg transition-colors shadow-sm">Î≤àÏó≠Í∏∞</a>
                        </div>
                    )}

                    {/* Footer */}
                    <footer className="p-4 text-center text-slate-500 dark:text-zinc-500 text-[10px] md:text-xs border-t border-slate-200 dark:border-zinc-800 bg-lightbg dark:bg-darkbg shrink-0 safe-pb">
                        üìß Î¨∏ÏùòÌïòÍ∏∞: <a href="mailto:mifaressel25@gmail.com" className="hover:text-slate-700 dark:hover:text-zinc-300 underline">mifaressel25@gmail.com</a>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
