<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JW Language Learning Player</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Babel CDNs -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; }
        @keyframes spin-slow {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin-slow { animation: spin-slow 8s linear infinite; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-950">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        /**
         * 안정적인 SVG 아이콘 컴포넌트
         */
        const Icon = ({ name, className = "w-5 h-5" }) => {
            const icons = {
                play: <path d="m5 3 14 9-14 9V3z" />,
                pause: <path d="M6 4h4v16H6zm8 0h4v16h-4z" />,
                search: <React.Fragment><circle cx="11" cy="11" r="8" /><path d="m21 21-4.3-4.3" /></React.Fragment>,
                globe: <React.Fragment><circle cx="12" cy="12" r="10" /><path d="M12 2a14.5 14.5 0 0 0 0 20" /><path d="M2 12h20" /></React.Fragment>,
                alert: <React.Fragment><circle cx="12" cy="12" r="10" /><line x1="12" y1="8" x2="12" y2="12" /><line x1="12" y1="16" x2="12.01" y2="16" /></React.Fragment>,
                refresh: <React.Fragment><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" /><path d="M3 3v5h5" /><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16" /><path d="M16 16h5v5" /></React.Fragment>,
                list: <React.Fragment><line x1="8" y1="6" x2="21" y2="6" /><line x1="8" y1="12" x2="21" y2="12" /><line x1="8" y1="18" x2="21" y2="18" /><line x1="3" y1="6" x2="3.01" y2="6" /><line x1="3" y1="12" x2="3.01" y2="12" /><line x1="3" y1="18" x2="3.01" y2="18" /></React.Fragment>,
                repeat: <React.Fragment><path d="m17 2 4 4-4 4" /><path d="M3 11V9a4 4 0 0 1 4-4h14" /><path d="m7 22-4-4 4-4" /><path d="M21 13v2a4 4 0 0 1-4 4H3" /></React.Fragment>,
                skipBack: <React.Fragment><polygon points="19 20 9 12 19 4 19 20" /><line x1="5" y1="19" x2="5" y2="5" /></React.Fragment>,
                skipForward: <React.Fragment><polygon points="5 4 15 12 5 20 5 4" /><line x1="19" y1="5" x2="19" y2="19" /></React.Fragment>
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    {icons[name] || null}
                </svg>
            );
        };

        const RAW_URL_CLEANER = (url) => url.replace('/refs/heads/', '/');
        const USER_GITHUB_BASE = "https://raw.githubusercontent.com/MultipePlayer/whateveryouwant/main/";
        const INDEX_URL = RAW_URL_CLEANER(`${USER_GITHUB_BASE}jw_data_index.json`);

        const App = () => {
            const [allItems, setAllItems] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [searchQuery, setSearchQuery] = useState('');
            const [selectedItem, setSelectedItem] = useState(null);
            const [currentLang, setCurrentLang] = useState('ko');
            const [currentTime, setCurrentTime] = useState(0);
            const [isPlaying, setIsPlaying] = useState(false);
            const [loopMode, setLoopMode] = useState(false); 
            const [selectedText, setSelectedText] = useState('');
            const [selectionPos, setSelectionPos] = useState({ x: 0, y: 0 });

            const videoRef = useRef(null);
            const subtitleRefs = { 
                ko: useRef([]), 
                en: useRef([]), 
                cn: useRef([]) 
            };

            // 특정 시간을 기준으로 해당 언어 스크립트에서 현재 문장의 인덱스를 찾는 함수
            const findActiveIndex = (script, time) => {
                if (!script || script.length === 0) return -1;
                let index = -1;
                for (let i = 0; i < script.length; i++) {
                    if (time >= script[i].start) {
                        index = i;
                    } else {
                        break;
                    }
                }
                return index;
            };

            const loadData = async () => {
                setLoading(true);
                setError(null);
                try {
                    const response = await fetch(INDEX_URL, { cache: 'no-cache' });
                    if (!response.ok) throw new Error("인덱스 파일을 찾을 수 없습니다.");
                    const index = await response.json();

                    const allLoaded = await Promise.all(
                        index.map(async (fileName) => {
                            try {
                                const fileUrl = RAW_URL_CLEANER(`${USER_GITHUB_BASE}${fileName}`);
                                const res = await fetch(fileUrl);
                                if (res.ok) return await res.json();
                                return [];
                            } catch (e) { return []; }
                        })
                    );
                    const flattened = allLoaded.flat().filter(item => item && item.natural_key);
                    setAllItems(flattened);
                } catch (err) {
                    setError(`데이터 동기화 실패: ${err.message}`);
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => { loadData(); }, []);

            // 언어별 독립적으로 현재 재생 시간에 맞는 자막 인덱스를 계산 (타임스탬프 불일치 해결)
            const activeIndices = useMemo(() => {
                return {
                    ko: findActiveIndex(selectedItem?.scripts?.ko, currentTime),
                    en: findActiveIndex(selectedItem?.scripts?.en, currentTime),
                    cn: findActiveIndex(selectedItem?.scripts?.cn, currentTime)
                };
            }, [currentTime, selectedItem]);

            const onTimeUpdate = () => {
                if (!videoRef.current) return;
                const v = videoRef.current;
                setCurrentTime(v.currentTime);

                // 루프 기능: 현재 활성화된 한국어 자막 구간을 반복 재생
                if (loopMode && selectedItem?.scripts?.ko && activeIndices.ko !== -1) {
                    const script = selectedItem.scripts.ko;
                    const startTime = script[activeIndices.ko].start;
                    const endTime = script[activeIndices.ko + 1]?.start || v.duration;
                    if (v.currentTime >= endTime - 0.2) {
                        v.currentTime = startTime;
                    }
                }
            };

            const handleSearch = (e) => {
                if (e) e.preventDefault();
                const item = allItems.find(i => i.title.toLowerCase().includes(searchQuery.toLowerCase()));
                if (item) { setSelectedItem(item); setSearchQuery(''); }
            };

            // 활성 자막이 바뀔 때마다 해당 위치로 자동 스크롤
            useEffect(() => {
                ['ko', 'en', 'cn'].forEach(langKey => {
                    const idx = activeIndices[langKey];
                    if (idx !== -1 && subtitleRefs[langKey].current[idx]) {
                        subtitleRefs[langKey].current[idx].scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                });
            }, [activeIndices]);

            if (loading) return (
                <div className="flex items-center justify-center h-screen bg-slate-900 text-white font-sans">
                    <div className="text-center">
                        <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-blue-500 mb-4 mx-auto"></div>
                        <p className="text-slate-400 font-medium">GitHub 데이터 동기화 중...</p>
                    </div>
                </div>
            );

            if (error) return (
                <div className="flex items-center justify-center h-screen bg-slate-900 text-white p-6 text-center">
                    <div className="max-w-md bg-slate-800 p-8 rounded-3xl border border-slate-700 shadow-2xl">
                        <Icon name="alert" className="w-16 h-16 text-red-500 mx-auto mb-6" />
                        <h2 className="text-2xl font-bold mb-3">연결 오류</h2>
                        <p className="text-slate-400 mb-8 text-sm leading-relaxed">{error}</p>
                        <button onClick={loadData} className="w-full py-3 bg-blue-600 rounded-xl font-bold flex items-center justify-center gap-2">
                            <Icon name="refresh" className="w-4 h-4" /> 다시 시도
                        </button>
                    </div>
                </div>
            );

            return (
                <div className="flex flex-col h-screen text-slate-900 dark:text-slate-100 overflow-hidden font-sans">
                    <header className="h-16 border-b bg-white dark:bg-slate-900 flex items-center justify-between px-6 shrink-0 z-20 shadow-sm border-slate-200 dark:border-slate-800">
                        <div className="flex items-center gap-2">
                            <div className="w-9 h-9 bg-gradient-to-tr from-blue-700 to-blue-500 rounded-xl flex items-center justify-center text-white font-black shadow-lg">JW</div>
                            <h1 className="font-bold text-lg hidden sm:block tracking-tight">Language Player</h1>
                        </div>
                        <form onSubmit={handleSearch} className="flex-1 max-w-2xl mx-6 relative">
                            <Icon name="search" className="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" />
                            <input type="text" placeholder="영상 제목 검색..." className="w-full bg-slate-100 dark:bg-slate-800 rounded-full py-2.5 pl-11 pr-4 outline-none text-sm border border-transparent focus:border-blue-500" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} />
                        </form>
                        <div className="px-3 py-1.5 bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 text-[10px] font-bold rounded-lg flex items-center gap-1.5 border border-blue-200 dark:border-blue-800">
                            <Icon name="globe" className="w-3 h-3" /> GitHub Live
                        </div>
                    </header>

                    <main className="flex-1 flex overflow-hidden">
                        <div className="flex-1 flex flex-col min-w-0 bg-black relative">
                            {!selectedItem ? (
                                <div className="flex-1 flex items-center justify-center bg-slate-900 text-slate-500 p-8">
                                    <div className="text-center max-w-sm">
                                        <Icon name="play" className="w-12 h-12 mb-6 opacity-20 mx-auto text-blue-500" />
                                        <h2 className="text-xl font-bold text-white mb-2">학습할 영상을 선택하세요</h2>
                                        <p className="text-sm mb-8">저장소에 {allItems.length}개의 영상이 동기화되어 있습니다.</p>
                                        <div className="flex flex-wrap gap-2 justify-center">
                                            {allItems.slice(0, 12).map(item => (
                                                <button key={item.natural_key} onClick={() => setSelectedItem(item)} className="px-4 py-2 bg-slate-800 hover:bg-blue-600 text-[11px] font-bold rounded-xl text-slate-200 transition-all border border-slate-700">
                                                    {item.title}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            ) : (
                                <>
                                    <div className="flex-1 relative flex items-center justify-center overflow-hidden">
                                        <video ref={videoRef} src={selectedItem.url} className="max-w-full max-h-full" onTimeUpdate={onTimeUpdate} onPlay={() => setIsPlaying(true)} onPause={() => setIsPlaying(false)} autoPlay />
                                        
                                        {/* 비디오 위 자막 오버레이 */}
                                        <div className="absolute bottom-16 left-0 right-0 px-10 pointer-events-none select-none">
                                            <div className="bg-black/60 backdrop-blur-xl text-white p-6 rounded-[2rem] text-center mx-auto max-w-4xl border border-white/10 shadow-2xl">
                                                <p className="text-3xl font-bold mb-3 tracking-tight leading-snug">
                                                    {selectedItem.scripts[currentLang]?.[activeIndices[currentLang]]?.text}
                                                </p>
                                                {currentLang !== 'ko' && (
                                                    <p className="text-xl text-slate-300 font-semibold opacity-90">
                                                        {selectedItem.scripts['ko']?.[activeIndices.ko]?.text}
                                                    </p>
                                                )}
                                            </div>
                                        </div>
                                    </div>

                                    {/* 플레이어 컨트롤러 */}
                                    <div className="bg-slate-900 text-white p-4 pb-8 border-t border-slate-800 shadow-2xl shrink-0">
                                        <div className="max-w-5xl mx-auto flex items-center justify-between">
                                            <div className="flex items-center gap-6">
                                                <button onClick={() => videoRef.current.currentTime -= 5} className="hover:text-blue-400"><Icon name="skipBack" className="w-6 h-6" /></button>
                                                <button onClick={() => isPlaying ? videoRef.current.pause() : videoRef.current.play()} className="w-14 h-14 bg-white text-black rounded-full flex items-center justify-center hover:scale-105 transition-transform shadow-lg">
                                                    {isPlaying ? <Icon name="pause" className="fill-current w-7 h-7" /> : <Icon name="play" className="ml-1 fill-current w-7 h-7" />}
                                                </button>
                                                <button onClick={() => videoRef.current.currentTime += 5} className="hover:text-blue-400"><Icon name="skipForward" className="w-6 h-6" /></button>
                                                <button onClick={() => setLoopMode(!loopMode)} className={`flex flex-col items-center gap-1 transition-all ${loopMode ? 'text-blue-500 scale-110' : 'text-slate-500 hover:text-white'}`}>
                                                    <Icon name="repeat" className={loopMode ? 'animate-spin-slow w-6 h-6' : 'w-6 h-6'} />
                                                    <span className="text-[9px] font-black uppercase">Repeat</span>
                                                </button>
                                            </div>
                                            <div className="flex bg-slate-800 rounded-2xl p-1.5 border border-slate-700 shadow-inner">
                                                {[
                                                    { id: 'ko', label: '한국어' },
                                                    { id: 'en', label: 'English' },
                                                    { id: 'cn', label: '中文' }
                                                ].map(l => (
                                                    <button key={l.id} onClick={() => setCurrentLang(l.id)} className={`px-5 py-2 text-xs font-black rounded-xl transition-all ${currentLang === l.id ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-500 hover:text-slate-200'}`}>
                                                        {l.label}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                </>
                            )}
                        </div>

                        {/* 우측 패널: 모든 언어 스크립트 대조 창 */}
                        <div className="w-[450px] lg:w-[600px] border-l bg-white dark:bg-slate-900 flex flex-col shadow-2xl z-20 dark:border-slate-800 shrink-0">
                            <div className="h-16 border-b flex items-center px-8 bg-slate-50 dark:bg-slate-800/50 dark:border-slate-800 font-black text-sm text-blue-600 tracking-tighter uppercase">
                                <Icon name="list" className="w-5 h-5 mr-3" /> Learning Script
                            </div>
                            <div className="flex-1 overflow-y-auto p-6 space-y-4 custom-scrollbar" onMouseUp={(e) => {
                                const s = window.getSelection().toString().trim();
                                if (s && s.length < 50) { setSelectedText(s); setSelectionPos({ x: e.clientX, y: e.clientY - 60 }); }
                                else setSelectedText('');
                            }}>
                                {/* 기준이 되는 한국어 스크립트 렌더링 */}
                                {selectedItem?.scripts.ko.map((line, koIdx) => {
                                    const isKoActive = activeIndices.ko === koIdx;
                                    
                                    // 타임스탬프 불일치 해결: 한국어 문장 시간을 기준으로 영/중 문장 독립 검색
                                    const enIdx = findActiveIndex(selectedItem.scripts.en, line.start);
                                    const cnIdx = findActiveIndex(selectedItem.scripts.cn, line.start);

                                    return (
                                        <div key={koIdx} onClick={() => videoRef.current.currentTime = line.start} className={`p-5 rounded-3xl transition-all cursor-pointer border ${isKoActive ? 'bg-blue-50 border-blue-200 dark:bg-blue-900/30 dark:border-blue-800 ring-4 ring-blue-500/10 shadow-lg' : 'border-slate-100 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800/80 hover:shadow-md'}`}>
                                            <div ref={el => subtitleRefs.ko.current[koIdx] = el} className={`text-base font-bold leading-snug ${isKoActive ? 'text-blue-800 dark:text-blue-400' : 'text-slate-800 dark:text-slate-200'}`}>
                                                <span className={`text-[10px] font-mono mr-3 px-2 py-0.5 rounded-md ${isKoActive ? 'bg-blue-500 text-white' : 'bg-slate-100 dark:bg-slate-800 text-slate-400'}`}>
                                                    {new Date(line.start * 1000).toISOString().substr(14, 5)}
                                                </span>
                                                {line.text}
                                            </div>
                                            
                                            <div className="mt-3 pl-10 border-l-2 border-slate-100 dark:border-slate-800 space-y-2 text-[13px] text-slate-500 leading-relaxed">
                                                {/* 중국어 문장 */}
                                                <div ref={el => { if(cnIdx !== -1) subtitleRefs.cn.current[cnIdx] = el }} className={activeIndices.cn === cnIdx ? "text-slate-900 dark:text-slate-100 font-medium" : ""}>
                                                    {selectedItem.scripts.cn[cnIdx]?.text || '-'}
                                                </div>
                                                {/* 영어 문장 */}
                                                <div ref={el => { if(enIdx !== -1) subtitleRefs.en.current[enIdx] = el }} className={`italic ${activeIndices.en === enIdx ? "text-slate-900 dark:text-slate-100 font-medium" : ""}`}>
                                                    {selectedItem.scripts.en[enIdx]?.text || '-'}
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </main>

                    {/* 사전 툴팁 */}
                    {selectedText && (
                        <div className="fixed z-[60] bg-white dark:bg-slate-800 shadow-2xl rounded-2xl p-3 flex gap-2 border border-slate-200 dark:border-slate-700 animate-in fade-in slide-in-from-bottom-2 duration-200" style={{ left: Math.min(window.innerWidth - 220, selectionPos.x), top: selectionPos.y }}>
                            <div className="absolute -bottom-2 left-1/2 -translate-x-1/2 w-4 h-4 bg-white dark:bg-slate-800 border-r border-b border-slate-200 dark:border-slate-700 rotate-45 shadow-sm" />
                            <a href={`https://dict.naver.com/search.nhn?query=${encodeURIComponent(selectedText)}`} target="_blank" className="px-4 py-2 bg-green-600 text-white text-[11px] font-black rounded-xl hover:bg-green-700 transition-all hover:scale-105 active:scale-95">Naver</a>
                            <a href={`https://translate.google.com/?sl=auto&tl=ko&text=${encodeURIComponent(selectedText)}`} target="_blank" className="px-4 py-2 bg-blue-600 text-white text-[11px] font-black rounded-xl hover:bg-blue-700 transition-all hover:scale-105 active:scale-95">Google</a>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
