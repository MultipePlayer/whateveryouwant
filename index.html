<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JW Language Player</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Babel (안정적인 버전 고정) -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; }
        @keyframes spin-slow {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin-slow { animation: spin-slow 8s linear infinite; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-950">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // 아이콘 컴포넌트 (SVG 직접 삽입으로 라이브러리 에러 원천 차단)
        const Icon = ({ name, className = "w-5 h-5" }) => {
            const icons = {
                play: <path d="m5 3 14 9-14 9V3z" />,
                pause: <path d="M6 4h4v16H6zm8 0h4v16h-4z" />,
                search: <React.Fragment><circle cx="11" cy="11" r="8" /><path d="m21 21-4.3-4.3" /></React.Fragment>,
                globe: <React.Fragment><circle cx="12" cy="12" r="10" /><path d="M12 2a14.5 14.5 0 0 0 0 20" /><path d="M2 12h20" /></React.Fragment>,
                alert: <React.Fragment><circle cx="12" cy="12" r="10" /><line x1="12" y1="8" x2="12" y2="12" /><line x1="12" y1="16" x2="12.01" y2="16" /></React.Fragment>,
                refresh: <React.Fragment><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" /><path d="M3 3v5h5" /><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16" /><path d="M16 16h5v5" /></React.Fragment>,
                list: <React.Fragment><line x1="8" y1="6" x2="21" y2="6" /><line x1="8" y1="12" x2="21" y2="12" /><line x1="8" y1="18" x2="21" y2="18" /><line x1="3" y1="6" x2="3.01" y2="6" /><line x1="3" y1="12" x2="3.01" y2="12" /><line x1="3" y1="18" x2="3.01" y2="18" /></React.Fragment>,
                repeat: <React.Fragment><path d="m17 2 4 4-4 4" /><path d="M3 11V9a4 4 0 0 1 4-4h14" /><path d="m7 22-4-4 4-4" /><path d="M21 13v2a4 4 0 0 1-4 4H3" /></React.Fragment>,
                skipBack: <React.Fragment><polygon points="19 20 9 12 19 4 19 20" /><line x1="5" y1="19" x2="5" y2="5" /></React.Fragment>,
                skipForward: <React.Fragment><polygon points="5 4 15 12 5 20 5 4" /><line x1="19" y1="5" x2="19" y2="19" /></React.Fragment>
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    {icons[name] || null}
                </svg>
            );
        };

        const RAW_URL_CLEANER = (url) => url.replace('/refs/heads/', '/');
        const USER_GITHUB_BASE = "https://raw.githubusercontent.com/MultipePlayer/whateveryouwant/main/";
        const INDEX_URL = RAW_URL_CLEANER(`${USER_GITHUB_BASE}jw_data_index.json`);

        const App = () => {
            const [allItems, setAllItems] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [searchQuery, setSearchQuery] = useState('');
            const [selectedItem, setSelectedItem] = useState(null);
            const [currentLang, setCurrentLang] = useState('ko');
            const [currentTime, setCurrentTime] = useState(0);
            const [isPlaying, setIsPlaying] = useState(false);
            const [loopMode, setLoopMode] = useState(false);
            const [selectedText, setSelectedText] = useState('');
            const [selectionPos, setSelectionPos] = useState({ x: 0, y: 0 });

            const videoRef = useRef(null);
            const subtitleRefs = { ko: useRef([]), en: useRef([]), cn: useRef([]) };

            const loadData = async () => {
                setLoading(true);
                setError(null);
                try {
                    const response = await fetch(INDEX_URL, { cache: 'no-cache' });
                    if (!response.ok) throw new Error("인덱스 파일을 찾을 수 없습니다.");
                    const index = await response.json();

                    const allLoaded = await Promise.all(
                        index.map(async (file) => {
                            const res = await fetch(RAW_URL_CLEANER(`${USER_GITHUB_BASE}${file}`));
                            return res.ok ? await res.json() : [];
                        })
                    );
                    setAllItems(allLoaded.flat().filter(i => i.natural_key));
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => { loadData(); }, []);

            const activeIdx = useMemo(() => {
                const script = selectedItem?.scripts?.ko;
                if (!script) return -1;
                let idx = -1;
                for (let i = 0; i < script.length; i++) {
                    if (currentTime >= script[i].start) idx = i;
                    else break;
                }
                return idx;
            }, [currentTime, selectedItem]);

            const onTimeUpdate = () => {
                if (!videoRef.current) return;
                setCurrentTime(videoRef.current.currentTime);
                if (loopMode && selectedItem?.scripts?.ko && activeIdx !== -1) {
                    const script = selectedItem.scripts.ko;
                    const endTime = script[activeIdx + 1]?.start || videoRef.current.duration;
                    if (videoRef.current.currentTime >= endTime - 0.2) {
                        videoRef.current.currentTime = script[activeIdx].start;
                    }
                }
            };

            useEffect(() => {
                if (activeIdx !== -1) {
                    ['ko', 'en', 'cn'].forEach(l => {
                        subtitleRefs[l].current[activeIdx]?.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    });
                }
            }, [activeIdx]);

            if (loading) return <div className="h-screen flex items-center justify-center bg-slate-900 text-white">동기화 중...</div>;
            if (error) return <div className="h-screen flex flex-col items-center justify-center bg-slate-900 text-white p-4">
                <Icon name="alert" className="w-12 h-12 text-red-500 mb-4" />
                <p>{error}</p>
                <button onClick={loadData} className="mt-4 px-4 py-2 bg-blue-600 rounded-lg">다시 시도</button>
            </div>;

            return (
                <div className="flex flex-col h-screen overflow-hidden">
                    <header className="h-16 border-b flex items-center justify-between px-6 bg-white dark:bg-slate-900 shrink-0">
                        <div className="flex items-center gap-2">
                            <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold">JW</div>
                            <span className="font-bold hidden sm:inline">Language Player</span>
                        </div>
                        <form onSubmit={(e) => { e.preventDefault(); const item = allItems.find(i => i.title.includes(searchQuery)); if (item) setSelectedItem(item); }} className="flex-1 max-w-xl mx-4 relative">
                            <Icon name="search" className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" />
                            <input type="text" value={searchQuery} onChange={e => setSearchQuery(e.target.value)} placeholder="제목 검색..." className="w-full pl-10 pr-4 py-2 bg-slate-100 dark:bg-slate-800 rounded-full outline-none text-sm" />
                        </form>
                        <div className="text-[10px] font-bold px-2 py-1 bg-green-100 text-green-700 rounded-md">LIVE</div>
                    </header>

                    <main className="flex-1 flex overflow-hidden">
                        <div className="flex-1 flex flex-col bg-black relative min-w-0">
                            {!selectedItem ? (
                                <div className="flex-1 flex flex-col items-center justify-center text-slate-500">
                                    <Icon name="play" className="w-12 h-12 mb-4 opacity-20" />
                                    <p>영상을 선택하세요</p>
                                    <div className="mt-4 flex flex-wrap gap-2 justify-center p-4">
                                        {allItems.slice(0, 10).map(i => <button key={i.natural_key} onClick={() => setSelectedItem(i)} className="px-3 py-1 bg-slate-800 text-white text-xs rounded-full">{i.title}</button>)}
                                    </div>
                                </div>
                            ) : (
                                <>
                                    <div className="flex-1 relative flex items-center justify-center overflow-hidden">
                                        <video ref={videoRef} src={selectedItem.url} className="max-w-full max-h-full" onTimeUpdate={onTimeUpdate} onPlay={() => setIsPlaying(true)} onPause={() => setIsPlaying(false)} autoPlay />
                                        <div className="absolute bottom-12 left-0 right-0 px-6 pointer-events-none">
                                            <div className="bg-black/60 backdrop-blur-md text-white p-4 rounded-2xl text-center max-w-2xl mx-auto shadow-2xl">
                                                <p className="text-2xl font-bold">{selectedItem.scripts[currentLang]?.[activeIdx]?.text}</p>
                                                {currentLang !== 'ko' && <p className="text-lg text-slate-300">{selectedItem.scripts.ko[activeIdx]?.text}</p>}
                                            </div>
                                        </div>
                                    </div>
                                    <div className="p-4 bg-slate-900 flex items-center justify-between text-white shrink-0">
                                        <div className="flex items-center gap-4">
                                            <button onClick={() => isPlaying ? videoRef.current.pause() : videoRef.current.play()} className="w-10 h-10 bg-white text-black rounded-full flex items-center justify-center">
                                                {isPlaying ? <Icon name="pause" /> : <Icon name="play" className="ml-1" />}
                                            </button>
                                            <button onClick={() => setLoopMode(!loopMode)} className={loopMode ? 'text-blue-500' : 'text-slate-500'}>
                                                <Icon name="repeat" className={loopMode ? 'animate-spin-slow' : ''} />
                                            </button>
                                        </div>
                                        <div className="flex gap-1 bg-slate-800 p-1 rounded-xl">
                                            {['ko', 'en', 'cn'].map(l => <button key={l} onClick={() => setCurrentLang(l)} className={`px-4 py-1.5 text-xs font-bold rounded-lg ${currentLang === l ? 'bg-blue-600' : ''}`}>{l.toUpperCase()}</button>)}
                                        </div>
                                    </div>
                                </>
                            )}
                        </div>

                        <div className="w-[400px] lg:w-[500px] border-l flex flex-col bg-white dark:bg-slate-900 shrink-0 shadow-xl">
                            <div className="h-14 border-b flex items-center px-6 font-bold text-sm text-blue-600"><Icon name="list" className="mr-2" /> SCRIPT</div>
                            <div className="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar" onMouseUp={e => {
                                const s = window.getSelection().toString().trim();
                                if (s) { setSelectedText(s); setSelectionPos({ x: e.clientX, y: e.clientY - 60 }); }
                                else setSelectedText('');
                            }}>
                                {selectedItem?.scripts.ko.map((line, idx) => (
                                    <div key={idx} onClick={() => videoRef.current.currentTime = line.start} className={`p-4 rounded-2xl cursor-pointer border transition-all ${activeIdx === idx ? 'bg-blue-50 border-blue-200 ring-2 ring-blue-100' : 'border-slate-100 hover:bg-slate-50'}`}>
                                        <div ref={el => subtitleRefs.ko.current[idx] = el} className={`text-sm font-bold ${activeIdx === idx ? 'text-blue-700' : ''}`}>{line.text}</div>
                                        <div className="mt-2 text-xs text-slate-500 space-y-1 pl-4 border-l-2">
                                            <div ref={el => subtitleRefs.cn.current[idx] = el}>{selectedItem.scripts.cn[idx]?.text}</div>
                                            <div ref={el => subtitleRefs.en.current[idx] = el} className="italic">{selectedItem.scripts.en[idx]?.text}</div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </main>

                    {selectedText && (
                        <div className="fixed z-50 bg-white shadow-2xl rounded-xl p-2 flex gap-2 border" style={{ left: selectionPos.x, top: selectionPos.y }}>
                            <a href={`https://dict.naver.com/search.nhn?query=${encodeURIComponent(selectedText)}`} target="_blank" className="px-3 py-1 bg-green-600 text-white text-[10px] font-bold rounded-lg">Naver</a>
                            <a href={`https://translate.google.com/?sl=auto&tl=ko&text=${encodeURIComponent(selectedText)}`} target="_blank" className="px-3 py-1 bg-blue-600 text-white text-[10px] font-bold rounded-lg">Google</a>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
