<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JW Multiple Player Pro - 아카이브 통합 에디션</title>
    <!-- React 및 필수 라이브러리 CDN -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* 커스텀 스크롤바 - 학습 시 방해되지 않도록 얇게 */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { border-radius: 10px; background: #1E6F54; }
        
        mark { color: inherit; border-radius: 2px; }

        /* 슬라이더 스타일 - 텍스트보다 튀지 않도록 작게 조정 */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 12px;
            width: 12px;
            border-radius: 50%;
            background: #1E6F54; 
            cursor: pointer;
            margin-top: -4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 3px;
            cursor: pointer;
            background: rgba(30, 111, 84, 0.2);
            border-radius: 2px;
        }

        /* 팝업 애니메이션 */
        .dict-popup { animation: fadeInScale 0.1s ease-out; z-index: 1000; }
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.95) translateY(5px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .loading-spinner {
            border: 2px solid rgba(30, 111, 84, 0.1);
            border-top: 2px solid #1E6F54;
            border-radius: 50%;
            width: 14px;
            height: 14px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        ::selection { background: #1E6F54; color: white; }

        @media (max-width: 1023px) {
            .sticky-video-container { position: sticky; top: 45px; z-index: 40; }
        }

        /* 자막 텍스트 외곽선 및 그림자 */
        .text-outline {
            text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000, 0 2px 4px rgba(0,0,0,0.8);
        }

        /* 가독성을 위해 모든 본문 텍스트에서 굵기(Bold) 제거 */
        p, span, div, button { font-weight: normal !important; }
        /* 명시적 강조가 필요한 주요 제목들만 예외 처리 */
        nav h1, h3, .brand-logo { font-weight: 800 !important; }
        
        /* 모바일 대응 */
        @media (max-width: 640px) {
            .control-box-text { font-size: 9px !important; }
        }
    </style>
</head>
<body class="bg-white text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect, useMemo } = React;

        const apiKey = ""; // Gemini API Key
        // GitHub 데이터 아카이브 인덱스 주소 (고정)
        const DEFAULT_ARCHIVE_URL = "https://raw.githubusercontent.com/MultipePlayer/whateveryouwant/refs/heads/main/data/jw_data_index.json";

        const Icon = ({ name, size = 14, className = "" }) => {
            const icons = {
                play: <polygon points="5 3 19 12 5 21 5 3"></polygon>,
                pause: <><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></>,
                sun: <><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></>,
                search: <><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></>,
                list: <><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></>,
                anchor: <path d="M12 22v-5m0-10V2m0 5a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5z"></path>,
                sliders: <><line x1="4" y1="21" x2="4" y2="14"></line><line x1="4" y1="10" x2="4" y2="3"></line><line x1="12" y1="21" x2="12" y2="12"></line><line x1="12" y1="8" x2="12" y2="3"></line><line x1="20" y1="21" x2="20" y2="16"></line><line x1="20" y1="12" x2="20" y2="3"></line><line x1="2" y1="14" x2="6" y2="14"></line><line x1="10" y1="8" x2="14" y2="8"></line><line x1="18" y1="16" x2="22" y2="16"></line></>,
                mouse: <path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z M13 13l6 6"></path>,
                help: <><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></>,
                globe: <><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></>,
                alert: <><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></>,
                sync: <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3" />,
                type: <><polyline points="4 7 4 4 20 4 20 7"></polyline><line x1="12" y1="4" x2="12" y2="20"></line><line x1="9" y1="20" x2="15" y2="20"></line></>,
                external: <><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></>
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || null}
                </svg>
            );
        };

        const App = () => {
            const [videoUrl, setVideoUrl] = useState("https://www.w3schools.com/html/mov_bbb.mp4");
            const [inputUrl, setInputUrl] = useState("");
            const [currentTime, setCurrentTime] = useState(0);
            const [duration, setDuration] = useState(0);
            const [isPlaying, setIsPlaying] = useState(false);
            const [playbackRate, setPlaybackRate] = useState(1.0); 
            const [isClipping, setIsClipping] = useState(false);
            const [showHelp, setShowHelp] = useState(false);
            const [dataLibrary, setDataLibrary] = useState({}); 
            const [syncStatus, setSyncStatus] = useState("idle"); 

            const [activeIdxKo, setActiveIdxKo] = useState(-1);
            const [activeIdxEn, setActiveIdxEn] = useState(-1);
            const [activeIdxZh, setActiveIdxZh] = useState(-1);
            
            const [anchorLang, setAnchorLang] = useState('ko');
            const [showKo, setShowKo] = useState(true);
            const [showZh, setShowZh] = useState(true);
            const [showEn, setShowEn] = useState(true);
            const [showPinyin, setShowPinyin] = useState(true);
            const [showVideoFontSettings, setShowVideoFontSettings] = useState(false);
            const [clickBehavior, setClickBehavior] = useState('play'); 
            const [searchTerm, setSearchTerm] = useState("");
            
            const [fontSizeKo, setFontSizeKo] = useState(18);
            const [fontSizeZh, setFontSizeZh] = useState(18);
            const [fontSizeEn, setFontSizeEn] = useState(18);

            const [scriptSizeKo, setScriptSizeKo] = useState(18);
            const [scriptSizeZh, setScriptSizeZh] = useState(18);
            const [scriptSizeEn, setScriptSizeEn] = useState(16);

            const [loopA, setLoopA] = useState(null);
            const [loopB, setLoopB] = useState(null);
            const [isLooping, setIsLooping] = useState(false);

            const [dictPopup, setDictPopup] = useState({ show: false, x: 0, y: 0, text: "" });

            const videoRef = useRef(null);
            const scrollRef = useRef(null);
            const listItemsRef = useRef([]);

            const [tracks, setTracks] = useState({ ko: [], zh: [], en: [] });

            // --- 아카이브 자동 동기화 로직 ---
            useEffect(() => {
                const syncArchive = async () => {
                    setSyncStatus("syncing");
                    try {
                        const indexRes = await fetch(DEFAULT_ARCHIVE_URL);
                        if (!indexRes.ok) throw new Error("Index load failed");
                        const indexData = await indexRes.json();
                        
                        const baseUrl = DEFAULT_ARCHIVE_URL.substring(0, DEFAULT_ARCHIVE_URL.lastIndexOf('/'));
                        let mergedLibrary = {};
                        
                        // 지도(indexData)에 명시된 chunkCount만큼 조각들 가져오기
                        for (let i = 1; i <= (indexData.chunkCount || 1); i++) {
                            const chunkRes = await fetch(`${baseUrl}/jw_data_${i}.json`);
                            if (chunkRes.ok) {
                                const chunkData = await chunkRes.json();
                                mergedLibrary = { ...mergedLibrary, ...chunkData };
                            }
                        }
                        
                        setDataLibrary(mergedLibrary);
                        setSyncStatus("ready");
                    } catch (e) {
                        console.error("동기화 에러:", e);
                        setSyncStatus("error");
                    }
                };
                syncArchive();
            }, []);

            // 미디어 코드 추출 로직 (Hash 링크 포함)
            const extractMediaCode = (url) => {
                if (!url) return null;
                // 1. 해시 뒤 아이템 코드 추출 (#ko/mediaitems/.../CODE)
                const hashPart = url.split('#')[1];
                if (hashPart) {
                    const parts = hashPart.split('/');
                    const lastPart = parts[parts.length - 1];
                    if (lastPart) return lastPart.replace('_VIDEO', '');
                }
                // 2. Query Parameter 추출 (item=CODE)
                const searchParams = new URLSearchParams(url.split('?')[1]);
                if (searchParams.has('item')) return searchParams.get('item');
                // 3. 일반 경로 추출
                const pathMatch = url.match(/\/([^/]+)_VIDEO/);
                if (pathMatch) return pathMatch[1];

                return null;
            };

            const handleClipVideo = async () => {
                if (!inputUrl.trim()) return;
                setIsClipping(true);

                const mediaCode = extractMediaCode(inputUrl);
                
                // 1. 동기화된 라이브러리(아카이브)에서 먼저 검색
                if (mediaCode && dataLibrary[mediaCode]) {
                    const data = dataLibrary[mediaCode];
                    setVideoUrl(data.videoUrl);
                    if (data.tracks) setTracks(data.tracks);
                    setIsClipping(false);
                    return;
                }

                // 2. 라이브러리에 없을 경우 Gemini AI 분석Fallback
                try {
                    const prompt = `Analyze URL: "${inputUrl}". Extract media code. Find direct MP4 link and transcripts for ko, zh (with pinyin), en. Return strictly JSON: { "videoUrl": "string", "tracks": { "ko": [], "zh": [], "en": [] } }. Precise float timestamps required.`;
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], tools: [{ "google_search": {} }], generationConfig: { responseMimeType: "application/json" } })
                    });
                    const result = await response.json();
                    const data = JSON.parse(result.candidates?.[0]?.content?.parts?.[0]?.text || "{}");
                    if (data.videoUrl) {
                        setVideoUrl(data.videoUrl);
                        if (data.tracks) setTracks(data.tracks);
                    } else {
                        alert("라이브러리에 데이터가 없으며 실시간 분석에도 실패했습니다.");
                    }
                } catch (err) { alert("분석 중 오류 발생."); } finally { setIsClipping(false); }
            };

            const togglePlay = () => {
                if (!videoRef.current) return;
                if (videoRef.current.paused) { videoRef.current.play(); setIsPlaying(true); } 
                else { videoRef.current.pause(); setIsPlaying(false); }
            };

            const handleTimeUpdate = () => {
                if (!videoRef.current) return;
                const time = videoRef.current.currentTime;
                setCurrentTime(time);
                if (isLooping && loopA !== null && loopB !== null && time >= loopB) { videoRef.current.currentTime = loopA; }
                setActiveIdxKo((tracks.ko || []).findIndex(it => time >= it.start && time < it.end));
                setActiveIdxEn((tracks.en || []).findIndex(it => time >= it.start && time < it.end));
                setActiveIdxZh((tracks.zh || []).findIndex(it => time >= it.start && time < it.end));
            };

            const seekTo = (sec) => {
                if (!videoRef.current) return;
                videoRef.current.currentTime = sec;
                if (clickBehavior === 'play') { videoRef.current.play(); setIsPlaying(true); } 
                else { videoRef.current.pause(); setIsPlaying(false); }
            };

            // 스크롤 위치 보정 (윗부분 안 잘리게)
            useEffect(() => {
                const leadIdx = anchorLang === 'ko' ? activeIdxKo : anchorLang === 'zh' ? activeIdxZh : activeIdxEn;
                if (leadIdx !== -1 && scrollRef.current && searchTerm === "") {
                    const activeElement = listItemsRef.current[leadIdx];
                    if (activeElement) {
                        const container = scrollRef.current;
                        const targetScrollTop = leadIdx === 0 ? 0 : activeElement.offsetTop - 120;
                        container.scrollTo({ top: Math.max(0, targetScrollTop), behavior: 'smooth' });
                    }
                }
            }, [activeIdxKo, activeIdxZh, activeIdxEn, anchorLang, searchTerm]);

            const handleMouseUp = (e) => {
                const selection = window.getSelection();
                const text = selection.toString().trim();
                if (text && text.length > 0) {
                    const range = selection.getRangeAt(0);
                    const rect = range.getBoundingClientRect();
                    setDictPopup({ show: true, x: rect.left + window.scrollX, y: rect.top + window.scrollY - 45, text: text });
                }
            };

            useEffect(() => {
                const handleGlobalClick = () => setDictPopup(prev => ({ ...prev, show: false }));
                window.addEventListener('mousedown', handleGlobalClick);
                return () => window.removeEventListener('mousedown', handleGlobalClick);
            }, []);

            const openDictionary = (text) => {
                const url = `https://dict.naver.com/search.nhn?query=${encodeURIComponent(text)}`;
                window.open(url, '_blank', 'width=1000,height=800');
                setDictPopup(prev => ({ ...prev, show: false }));
            };

            const highlightText = (text, queries) => {
                if (!queries || queries.length === 0 || !text) return text;
                const pattern = queries.map(q => q.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')).join('|');
                const parts = text.split(new RegExp(`(${pattern})`, 'gi'));
                return parts.map((part, i) => 
                    queries.some(q => q.toLowerCase() === part.toLowerCase()) ? 
                    <mark key={i} className="bg-emerald-100 text-emerald-900">{part}</mark> : part
                );
            };

            const searchWords = useMemo(() => searchTerm.trim().split(/\s+/).filter(w => w.length > 0), [searchTerm]);

            const anchorList = useMemo(() => {
                const leadTrack = tracks[anchorLang] || [];
                return leadTrack.map((leadItem, idx) => {
                    const midTime = (leadItem.start + leadItem.end) / 2;
                    const findMatched = (track) => track.find(it => midTime >= it.start && midTime < it.end) || track.find(it => leadItem.start >= it.start && leadItem.start < it.end);
                    return {
                        id: idx, start: leadItem.start, end: leadItem.end,
                        ko: anchorLang === 'ko' ? leadItem.text : findMatched(tracks.ko || [])?.text || "",
                        zh: anchorLang === 'zh' ? leadItem.text : findMatched(tracks.zh || [])?.text || "",
                        pinyin: anchorLang === 'zh' ? leadItem.pinyin : findMatched(tracks.zh || [])?.pinyin || "",
                        en: anchorLang === 'en' ? leadItem.text : findMatched(tracks.en || [])?.text || ""
                    };
                });
            }, [anchorLang, tracks]);

            const filteredList = useMemo(() => {
                if (searchWords.length === 0) return anchorList;
                return anchorList.filter(it => {
                    const combined = `${it.ko} ${it.zh} ${it.en} ${it.pinyin}`.toLowerCase();
                    return searchWords.every(word => combined.includes(word.toLowerCase()));
                });
            }, [anchorList, searchWords]);

            const setAllVideoFontSize = (size) => { setFontSizeKo(size); setFontSizeZh(size); setFontSizeEn(size); };
            const setAllScriptSize = (size) => { setScriptSizeKo(size); setScriptSizeZh(size); setScriptSizeEn(size); };

            const buttonAccent = "bg-[#1E6F54] hover:bg-[#154d3a]";
            const accentText = "text-[#1E6F54]";

            return (
                <div className="min-h-screen font-sans flex flex-col relative overflow-hidden bg-white text-slate-900">
                    
                    {/* 네비게이션 바 */}
                    <nav className="h-[45px] border-b px-4 lg:px-6 flex items-center justify-between sticky top-0 bg-white/95 backdrop-blur-md z-50">
                        <div className="flex items-center gap-3">
                            <div className="bg-[#1E6F54] w-6 h-6 rounded-lg flex items-center justify-center font-black text-white text-[10px] shadow-sm brand-logo">MP</div>
                            <h1 className="text-[11px] lg:text-[12px] text-[#1E6F54] tracking-tight hidden sm:block uppercase">JW Player Pro</h1>
                        </div>
                        
                        <div className="flex items-center gap-3 flex-1 max-w-lg mx-6 relative">
                            <div className="relative w-full">
                                <Icon name="globe" size={12} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500" />
                                <input type="text" placeholder="영상 주소(해시 링크 포함)를 입력하세요..." className="w-full pl-9 pr-8 py-1.5 rounded-lg border border-slate-300 text-xs outline-none focus:ring-1 focus:ring-emerald-500 bg-white" value={inputUrl} onChange={(e) => setInputUrl(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleClipVideo()} />
                                <button onClick={() => setShowHelp(!showHelp)} className="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-emerald-600"><Icon name="help" size={12} /></button>
                            </div>
                            <button onClick={handleClipVideo} disabled={isClipping} className="px-4 py-1.5 bg-[#1E6F54] text-white text-[10px] rounded-lg shrink-0 flex items-center gap-2 active:scale-95 disabled:opacity-50 transition-all">
                                {isClipping ? <div className="loading-spinner"></div> : "검색"}
                            </button>
                        </div>
                        <div className="flex items-center gap-2">
                             <div className={`text-[9px] px-2 py-0.5 rounded-full border flex items-center gap-1.5 ${syncStatus === 'ready' ? 'bg-emerald-50 text-emerald-700 border-emerald-200' : 'bg-slate-50 text-slate-400 border-slate-200'}`}>
                                <Icon name="sync" size={10} className={syncStatus === 'syncing' ? 'animate-spin' : ''} />
                                {syncStatus === 'ready' ? 'Archive Loaded' : syncStatus === 'syncing' ? 'Syncing...' : 'Sync Pending'}
                             </div>
                        </div>
                    </nav>

                    <main className="max-w-[1700px] mx-auto p-3 lg:p-4 grid grid-cols-1 lg:grid-cols-10 gap-4 flex-1 w-full overflow-hidden">
                        
                        {/* 왼쪽 섹션 (6) */}
                        <div className="lg:col-span-6 flex flex-col gap-4 sticky-video-container">
                            
                            <div className="aspect-video rounded-[1.5rem] lg:rounded-[2rem] overflow-hidden shadow-lg relative border-2 border-slate-100 bg-black">
                                <video key={videoUrl} ref={videoRef} onClick={togglePlay} className="w-full h-full object-contain cursor-pointer" onTimeUpdate={handleTimeUpdate} onLoadedMetadata={(e) => setDuration(e.target.duration)} playsInline>
                                    <source src={videoUrl} type="video/mp4" />
                                </video>
                                
                                <div className="absolute inset-x-0 bottom-0 p-4 lg:p-6 text-center pointer-events-none flex flex-col items-center justify-end min-h-[40%]">
                                    <div className="space-y-1.5 flex flex-col items-center w-full">
                                        {showKo && activeIdxKo !== -1 && (
                                            <p className="bg-black/70 rounded-lg px-4 py-1.5 text-white text-outline inline-block tracking-tight leading-snug" style={{ fontSize: `${fontSizeKo}px` }}>
                                                {tracks.ko[activeIdxKo].text}
                                            </p>
                                        )}
                                        {showZh && activeIdxZh !== -1 && (
                                            <div className="flex flex-col items-center gap-1">
                                                {showPinyin && (
                                                    <span className="bg-black/70 rounded px-2.5 py-0.5 text-white text-outline inline-block tracking-wide text-xs" style={{ fontSize: `${fontSizeZh * 0.6}px` }}>
                                                        {tracks.zh[activeIdxZh].pinyin}
                                                    </span>
                                                )}
                                                <p className="bg-black/70 rounded-lg px-4 py-1.5 text-white text-outline inline-block tracking-wide leading-snug" style={{ fontSize: `${fontSizeZh}px` }}>
                                                    {tracks.zh[activeIdxZh].text}
                                                </p>
                                            </div>
                                        )}
                                        {showEn && activeIdxEn !== -1 && (
                                            <p className="bg-black/70 rounded-lg px-4 py-1.5 text-white text-outline inline-block tracking-tight leading-snug" style={{ fontSize: `${fontSizeEn}px` }}>
                                                {tracks.en[activeIdxEn].text}
                                            </p>
                                        )}
                                    </div>
                                </div>
                            </div>

                            {/* 컨트롤 및 설정 박스 */}
                            <div className="p-4 lg:p-5 rounded-[1.5rem] border-2 border-slate-200 bg-white flex flex-col gap-4 shadow-sm">
                                <div className="flex items-center gap-4 text-[10px]">
                                    <button onClick={togglePlay} className="bg-[#1E6F54] w-10 h-10 rounded-xl flex items-center justify-center text-white shadow-md active:scale-95 transition-all shrink-0">
                                        <Icon name={isPlaying ? "pause" : "play"} size={16} />
                                    </button>
                                    <div className="flex-1">
                                        <div className="flex justify-between items-end mb-1 px-1">
                                            <span className="text-slate-500 uppercase tracking-widest">PLAYING</span>
                                            <span className="font-mono text-slate-900">{Math.floor(currentTime)}s / {Math.floor(duration)}s</span>
                                        </div>
                                        <div className="h-1.5 rounded-full relative overflow-hidden cursor-pointer bg-slate-100" onClick={(e) => {
                                            const rect = e.currentTarget.getBoundingClientRect();
                                            seekTo(((e.clientX - rect.left) / rect.width) * duration);
                                        }}>
                                            <div className="h-full bg-[#1E6F54] transition-all" style={{ width: `${(currentTime / (duration || 1)) * 100}%` }} />
                                        </div>
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-5 pt-1 border-t border-slate-100 text-[10px]">
                                    <div className="space-y-3">
                                        <div className="space-y-1.5">
                                            <label className="text-slate-500 uppercase flex items-center gap-1.5"><Icon name="globe" size={12}/> 자막 활성화</label>
                                            <div className="flex p-0.5 rounded-lg border border-slate-200 bg-slate-50">
                                                {[{id: 'KO', state: showKo, set: setShowKo}, {id: 'ZH', state: showZh, set: setShowZh}, {id: 'EN', state: showEn, set: setShowEn}].map(l => (
                                                    <button key={l.id} onClick={() => l.set(!l.state)} className={`flex-1 py-1 rounded-md transition-all ${l.state ? 'bg-[#1E6F54] text-white shadow-sm' : 'text-slate-500'}`}>{l.id}</button>
                                                ))}
                                            </div>
                                        </div>
                                        <div className="space-y-1.5">
                                            <label className="text-slate-500 uppercase flex items-center gap-1.5"><Icon name="mouse" size={12}/> 스크립트 클릭 시 동작</label>
                                            <div className="flex p-0.5 rounded-lg border border-slate-200 bg-slate-50">
                                                <button onClick={() => setClickBehavior('play')} className={`flex-1 py-1 rounded-md transition-all ${clickBehavior === 'play' ? 'bg-[#1E6F54] text-white' : 'text-slate-500'}`}>바로 재생</button>
                                                <button onClick={() => setClickBehavior('pause')} className={`flex-1 py-1 rounded-md transition-all ${clickBehavior === 'pause' ? 'bg-[#1E6F54] text-white' : 'text-slate-500'}`}>정지 이동</button>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="space-y-3">
                                        <div className="space-y-1.5">
                                            <div className="flex justify-between text-slate-500 uppercase">배속 설정 <span className="text-emerald-700">{playbackRate}x</span></div>
                                            <div className="flex p-0.5 rounded-lg border border-slate-200 bg-slate-50">
                                                {[0.8, 1.0, 1.2, 1.5].map(rate => (
                                                    <button key={rate} onClick={() => handleRateChange(rate)} className={`flex-1 py-1 rounded-md transition-all ${playbackRate === rate ? 'bg-[#1E6F54] text-white shadow-sm' : 'text-slate-500 hover:text-emerald-700'}`}>{rate}x</button>
                                                ))}
                                            </div>
                                        </div>
                                        <div className="space-y-1.5">
                                            <div className="flex justify-between text-slate-500 uppercase tracking-widest">구간 반복 설정</div>
                                            <div className="grid grid-cols-3 gap-1 p-0.5 rounded-lg border border-slate-200 bg-slate-50 h-[32px]">
                                                <button onClick={() => setLoopA(currentTime)} className={`rounded-md border transition-all ${loopA !== null ? 'bg-emerald-100 text-emerald-800 border-emerald-300' : 'bg-white text-slate-500 border-slate-200'}`}>A</button>
                                                <button onClick={() => setLoopB(currentTime)} className={`rounded-md border transition-all ${loopB !== null ? 'bg-emerald-100 text-emerald-800 border-emerald-300' : 'bg-white text-slate-500 border-slate-200'}`}>B</button>
                                                <button onClick={() => setIsLooping(!isLooping)} disabled={loopA === null || loopB === null} className={`rounded-md transition-all border flex items-center justify-center ${isLooping ? 'bg-emerald-700 text-white border-emerald-800 shadow-sm' : 'bg-white text-slate-400 border-slate-200 opacity-50'}`}>
                                                  {isLooping ? 'ON' : 'OFF'}
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div className="border-t border-slate-100 pt-3 text-[10px]">
                                    <div className="flex items-center justify-between mb-3 px-1">
                                        <button onClick={() => setShowVideoFontSettings(!showVideoFontSettings)} className="flex items-center gap-1.5 text-slate-600 uppercase">
                                            <Icon name="sliders" size={12} /> 영상 자막 크기 조절 {showVideoFontSettings ? '▲' : '▼'}
                                        </button>
                                        <button onClick={() => setAllVideoFontSize(18)} className="text-[#1E6F54] bg-[#1E6F54]/10 px-2 py-0.5 rounded transition-colors hover:bg-[#1E6F54]/20">전체 18px로</button>
                                    </div>

                                    {showVideoFontSettings && (
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 pb-2 animate-in">
                                            {[ {label: 'KO', val: fontSizeKo, set: setFontSizeKo}, {label: 'ZH', val: fontSizeZh, set: setFontSizeZh}, {label: 'EN', val: fontSizeEn, set: setFontSizeEn} ].map((l, i) => (
                                                <div key={i} className="space-y-1 px-1">
                                                    <div className="flex justify-between text-slate-500 uppercase"><span>{l.label} Size</span><span>{l.val}px</span></div>
                                                    <input type="range" min="14" max="25" value={l.val} onChange={(e) => l.set(Number(e.target.value))} className="w-full" />
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* 스크립트 섹션 (4) */}
                        <div className="lg:col-span-4 flex flex-col rounded-[1.5rem] lg:rounded-[2.5rem] border-2 border-slate-200 overflow-hidden h-[85vh] relative bg-white shadow-sm">
                            
                            <div className="p-4 lg:p-5 border-b border-slate-100 flex flex-col gap-3 bg-slate-50">
                                <div className="space-y-1">
                                    <h3 className="text-sm flex items-center gap-2 text-slate-900 uppercase"><Icon name="list" size={16} className="text-[#1E6F54]" /> 학습 스크립트</h3>
                                    <div className="flex flex-col gap-0.5 px-1 py-1 bg-white/50 rounded-lg border border-slate-200/50">
                                        <p className="text-[9px] text-slate-600 leading-relaxed">
                                            ※ 언어마다 어순이 다릅니다. 학습 기준 언어를 먼저 선택하세요.<br/>
                                            ※ 텍스트 드래그 시 즉시 단어 사전 검색이 가능합니다.
                                        </p>
                                    </div>
                                </div>

                                <div className="flex flex-wrap items-center justify-between gap-2 border-t border-slate-200 pt-3">
                                    <div className="flex items-center gap-2">
                                        <Icon name="anchor" size={14} className="text-[#1E6F54]" />
                                        <div className="flex p-0.5 rounded-lg border border-slate-200 bg-white shadow-xs">
                                            {['ko','zh','en'].map(l => (
                                                <button key={l} onClick={() => setAnchorLang(l)} className={`px-3 py-1 rounded-md text-[10px] transition-all ${anchorLang === l ? 'bg-[#1E6F54] text-white shadow-sm' : 'text-slate-500 hover:text-slate-900'}`}>{l.toUpperCase()}</button>
                                            ))}
                                        </div>
                                    </div>
                                    <label className="flex items-center gap-1.5 cursor-pointer px-2 py-1 rounded-md border border-slate-200 bg-white shadow-sm hover:bg-slate-50">
                                        <span className="text-[10px] font-medium text-slate-500">병음 표시</span>
                                        <input type="checkbox" checked={showPinyin} onChange={(e) => setShowPinyin(e.target.checked)} className="sr-only" />
                                        <div className={`w-6 h-3 rounded-full relative transition-colors ${showPinyin ? 'bg-[#1E6F54]' : 'bg-slate-300'}`}>
                                            <div className={`absolute left-0.5 top-0.5 bg-white w-2 h-2 rounded-full transition-transform ${showPinyin ? 'translate-x-3' : 'translate-x-0'}`}></div>
                                        </div>
                                    </label>
                                </div>

                                <div className="space-y-1">
                                    <div className="relative">
                                        <Icon name="search" size={12} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500" />
                                        <input type="text" placeholder="스크립트 내용 검색..." className="w-full pl-8 pr-4 py-2 rounded-lg border border-slate-200 text-[11px] outline-none transition-all focus:ring-1 focus:ring-emerald-500 bg-white text-slate-900 font-normal" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
                                    </div>
                                    <div className="px-1 text-[9px] text-red-600 flex items-center gap-1">
                                        <Icon name="alert" size={10} /> 문맥에 따라 의역이 포함되어 있을 수 있습니다.
                                    </div>
                                </div>
                            </div>

                            <div ref={scrollRef} onMouseUp={handleMouseUp} className="flex-1 overflow-y-auto p-4 lg:p-5 space-y-4 custom-scrollbar select-text bg-white">
                                {filteredList.length > 0 ? (
                                    filteredList.map((item, index) => {
                                        const isActive = (anchorLang === 'ko' && activeIdxKo === index) || (anchorLang === 'zh' && activeIdxZh === index) || (anchorLang === 'en' && activeIdxEn === index);
                                        return (
                                            <div 
                                                key={index} 
                                                ref={el => listItemsRef.current[index] = el}
                                                onClick={() => seekTo(item.start)} 
                                                className={`p-4 rounded-xl cursor-pointer transition-all border relative overflow-hidden group ${isActive && searchTerm === "" ? 'bg-emerald-50/50 border-emerald-500/30 ring-1 ring-emerald-500/10' : 'bg-white border-slate-100 hover:border-emerald-500/10 hover:shadow-xs'}`}
                                            >
                                                <div className="flex justify-between items-center mb-2">
                                                    <span className={`text-[8px] font-mono px-1.5 py-0.5 rounded ${isActive ? 'bg-[#1E6F54] text-white shadow-sm' : 'bg-slate-100 text-slate-500'}`}>{Math.floor(item.start)}s</span>
                                                </div>
                                                <div className="space-y-3 pointer-events-none text-slate-900">
                                                    {showKo && item.ko && <p className="leading-snug transition-all font-normal text-slate-800" style={{ fontSize: `${scriptSizeKo}px` }}>{highlightText(item.ko, searchWords)}</p>}
                                                    {showZh && item.zh && (
                                                        <div className="space-y-1.5">
                                                            {showPinyin && item.pinyin && <span className="px-1.5 py-0.5 inline-block text-[11px] rounded transition-all bg-slate-50 text-slate-500 border border-slate-100 font-normal" style={{ fontSize: `${scriptSizeZh * 0.7}px` }}>{highlightText(item.pinyin, searchWords)}</span>}
                                                            <p className="leading-relaxed transition-all font-normal text-slate-800" style={{ fontSize: `${scriptSizeZh}px` }}>{highlightText(item.zh, searchWords)}</p>
                                                        </div>
                                                    )}
                                                    {showEn && item.en && <p className="leading-relaxed transition-all font-normal text-slate-500" style={{ fontSize: `${scriptSizeEn}px` }}>{highlightText(item.en, searchWords)}</p>}
                                                </div>
                                            </div>
                                        );
                                    })
                                ) : (
                                    <div className="text-center py-20 opacity-30 italic text-xs text-slate-900">데이터가 없거나 검색 결과가 없습니다.</div>
                                )}
                            </div>

                            <div className="px-6 py-3 border-t border-slate-100 flex flex-col gap-2 bg-slate-50">
                                <div className="flex items-center justify-between">
                                    <div className="flex items-center gap-1.5 text-slate-600 font-black text-[9px] uppercase tracking-widest">
                                        <Icon name="type" size={12} /> 스크립트 텍스트 크기
                                    </div>
                                    <button onClick={() => setAllScriptSize(18)} className="text-[9px] font-normal text-[#1E6F54] hover:underline transition-colors">모두 18px로</button>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    {[ {label: 'KO', val: scriptSizeKo, set: setScriptSizeKo}, {label: 'ZH', val: scriptSizeZh, set: setScriptSizeZh}, {label: 'EN', val: scriptSizeEn, set: setScriptSizeEn} ].map((l, i) => (
                                        <div key={i} className="flex items-center gap-2">
                                            <span className="text-[10px] font-black text-slate-500 w-4">{l.label}</span>
                                            <input type="range" min="10" max="30" value={l.val} onChange={(e) => l.set(Number(e.target.value))} className="flex-1 h-1" />
                                            <span className="text-[9px] font-mono text-slate-700 w-3">{l.val}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {/* 사전 검색 팝업 */}
                            {dictPopup.show && (
                                <div 
                                    className="dict-popup fixed bg-slate-900 text-white rounded-xl px-3 py-1.5 flex items-center gap-3 shadow-2xl border border-white/20 whitespace-nowrap pointer-events-auto"
                                    style={{ left: dictPopup.x, top: dictPopup.y }}
                                    onMouseDown={(e) => e.stopPropagation()} 
                                >
                                    <span className="text-[10px] font-normal text-emerald-400 truncate max-w-[100px]">"{dictPopup.text}"</span>
                                    <div className="w-[1px] h-3 bg-white/20"></div>
                                    <button onClick={() => openDictionary(dictPopup.text)} className="flex items-center gap-1 bg-[#1E6F54] hover:bg-emerald-500 px-2 py-1 rounded-lg transition-all text-[9px] font-normal shadow-lg">
                                        <Icon name="external" size={10} /> 사전 검색
                                    </button>
                                </div>
                            )}
                        </div>
                    </main>

                    {/* 푸터 */}
                    <footer className="h-[30px] px-6 border-t border-slate-200 flex items-center justify-between text-[10px] text-slate-400 bg-white">
                        <div className="flex items-center gap-4 uppercase tracking-widest">
                            <span>JW Player Pro v16.9 Archive Edition</span>
                            <div className="flex items-center gap-1 text-emerald-700/60">
                              <Icon name="sync" size={10} className={syncStatus === 'syncing' ? 'animate-spin' : ''} />
                              Auto-Synced with Library
                            </div>
                        </div>
                        <div className="flex items-center gap-4">
                            <span className="text-emerald-700/50 italic font-medium tracking-tight">Smart Library & Auto-Matching System</span>
                        </div>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
