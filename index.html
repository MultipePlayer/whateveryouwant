<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JW Multiple Subtitle Player</title>
    <!-- 라이브러리 로드 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&family=Noto+Sans+SC:wght@300;400;500;700;900&display=swap');
        
        body { font-family: 'Noto Sans KR', 'Noto Sans SC', sans-serif; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { border-radius: 10px; background: #1E6F54; }
        
        .text-outline {
            text-shadow: -1.5px -1.5px 0 #000, 1.5px -1.5px 0 #000, -1.5px 1.5px 0 #000, 1.5px 1.5px 0 #000, 0 2px 4px rgba(0,0,0,0.9);
        }

        .loading-dots:after {
            content: '.';
            animation: dots 1s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60% { content: '...'; }
            80%, 100% { content: ''; }
        }

        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 14px; width: 14px; border-radius: 50%;
            background: #1E6F54; cursor: pointer; margin-top: -5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: rgba(30, 111, 84, 0.2); border-radius: 2px;
        }

        .status-banner {
            animation: slideDown 0.3s ease-out;
        }
        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect, useMemo } = React;

        const Icon = ({ name, size = 16, className = "" }) => {
            const icons = {
                play: <path d="M5 3l14 9-14 9V3z" />,
                pause: <path d="M6 4h4v16H6zm8 0h4v16h-4z" />,
                globe: (
                    <>
                        <circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                    </>
                ),
                search: (
                    <>
                        <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
                    </>
                ),
                settings: (
                    <>
                        <circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </>
                ),
                external: (
                    <>
                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><path d="M15 3h6v6"/><path d="M10 14L21 3"/>
                    </>
                ),
                database: (
                    <>
                        <ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>
                    </>
                ),
                alert: (
                    <>
                        <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
                    </>
                )
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || null}
                </svg>
            );
        };

        const App = () => {
            const [videoUrl, setVideoUrl] = useState("");
            const [inputUrl, setInputUrl] = useState("");
            const [isLoading, setIsLoading] = useState(false);
            const [status, setStatus] = useState({ type: null, message: "" });
            const [isPlaying, setIsPlaying] = useState(false);
            const [currentTime, setCurrentTime] = useState(0);
            const [duration, setDuration] = useState(0);
            const [playbackRate, setPlaybackRate] = useState(1.0);
            
            const [tracks, setTracks] = useState({ ko: [], zh: [], en: [] });
            const [activeIndices, setActiveIndices] = useState({ ko: -1, zh: -1, en: -1 });
            const [anchorLang, setAnchorLang] = useState('ko');
            
            const [archiveData, setArchiveData] = useState([]);
            const [archiveUrl, setArchiveUrl] = useState(""); 
            const [showArchive, setShowArchive] = useState(false);

            const [showLangs, setShowLangs] = useState({ ko: true, zh: true, en: true });
            const [showPinyin, setShowPinyin] = useState(true);
            const [videoFontSize, setVideoFontSize] = useState(20);
            const [scriptFontSize, setScriptFontSize] = useState(16);
            const [searchTerm, setSearchTerm] = useState("");
            const [archiveSearch, setArchiveSearch] = useState("");
            
            const [loopA, setLoopA] = useState(null);
            const [loopB, setLoopB] = useState(null);
            const [isLooping, setIsLooping] = useState(false);

            const videoRef = useRef(null);
            const scrollRef = useRef(null);
            const itemRefs = useRef([]);
            const apiKey = ""; 

            const parseVTT = async (url) => {
                if (!url) return [];
                try {
                    const res = await fetch(url);
                    const text = await res.text();
                    const lines = text.split(/\r?\n/);
                    const scriptData = [];
                    let currentStart = 0;
                    let currentText = [];
                    const timePattern = /((?:\d{2}:)?\d{2}:\d{2}\.\d{3})\s*-->/;

                    const timeToSeconds = (str) => {
                        const parts = str.split(':');
                        if (parts.length === 3) {
                            const [h, m, s_ms] = parts;
                            const [s, ms] = s_ms.split('.');
                            return parseInt(h) * 3600 + parseInt(m) * 60 + parseInt(s) + parseInt(ms) / 1000;
                        } else {
                            const [m, s_ms] = parts;
                            const [s, ms] = s_ms.split('.');
                            return parseInt(m) * 60 + parseInt(s) + parseInt(ms) / 1000;
                        }
                    };

                    lines.forEach(line => {
                        const match = line.match(timePattern);
                        if (match) {
                            if (currentText.length > 0) {
                                scriptData.push({ start: currentStart, end: timeToSeconds(match[1]), text: currentText.join(' ').replace(/<[^>]+>/g, '').trim() });
                            }
                            currentStart = timeToSeconds(match[1]);
                            currentText = [];
                        } else if (line.trim() && !line.includes('WEBVTT') && !line.includes('NOTE') && !/^\d+$/.test(line.trim())) {
                            currentText.push(line.trim());
                        }
                    });
                    return scriptData;
                } catch (e) { return []; }
            };

            const fetchJWMedia = async (naturalKey) => {
                const langs = { ko: 'KO', en: 'E', zh: 'CHS' };
                const results = { videoUrl: "", tracks: { ko: [], en: [], zh: [] } };

                for (const [key, code] of Object.entries(langs)) {
                    try {
                        const api = `https://b.jw-cdn.org/apis/mediator/v1/media-items/${code}/${naturalKey}?clientType=www`;
                        const res = await fetch(api);
                        const data = await res.json();
                        const media = data.media?.[0];
                        if (!media) continue;

                        const file720 = media.files?.find(f => f.label === '720p') || media.files?.[0];
                        if (key === 'ko') results.videoUrl = file720?.progressiveDownloadURL;
                        
                        const subUrl = file720?.subtitles?.url || media.files?.find(f => f.subtitles)?.subtitles?.url;
                        if (subUrl) {
                            results.tracks[key] = await parseVTT(subUrl);
                        }
                    } catch (e) { console.error(e); }
                }
                return results;
            };

            const handleAnalyze = async () => {
                const url = inputUrl.trim();
                if (!url) return;
                
                setIsLoading(true);
                setStatus({ type: "info", message: "데이터 분석 중..." });

                try {
                    // URL에서 고유 코드(naturalKey) 추출 (예: pub-jwb-133_3_VIDEO)
                    const keyMatch = url.match(/pub-([\w-]+)_VIDEO/) || url.match(/item=([\w-]+)/) || url.match(/pub-([\w-]+)/) || url.match(/lank=([\w-]+)/);
                    const naturalKey = keyMatch ? keyMatch[1] : null;

                    // --- [신규 기능] 1순위: 아카이브 검색 ---
                    if (archiveData.length > 0) {
                        const foundInArchive = archiveData.find(item => 
                            (naturalKey && item.natural_key === naturalKey) || 
                            item.url === url || 
                            url.includes(item.natural_key)
                        );

                        if (foundInArchive) {
                            setVideoUrl(foundInArchive.url);
                            setTracks(foundInArchive.scripts);
                            setStatus({ type: "success", message: "아카이브에서 데이터를 찾아 즉시 로드했습니다." });
                            setTimeout(() => setStatus({ type: null, message: "" }), 3000);
                            setIsLoading(false);
                            return;
                        }
                    }

                    // --- 2순위: 외부 API 다이렉트 호출 ---
                    if (naturalKey) {
                        setStatus({ type: "info", message: `ID(${naturalKey}) 확인. JW API에서 실시간 추출 중...` });
                        const directData = await fetchJWMedia(naturalKey);
                        if (directData.videoUrl) {
                            setVideoUrl(directData.videoUrl);
                            setTracks(directData.tracks);
                            setStatus({ type: "success", message: "실시간 API 연결에 성공했습니다." });
                            setTimeout(() => setStatus({ type: null, message: "" }), 2000);
                            setIsLoading(false);
                            return;
                        }
                    }

                    // --- 3순위: Gemini AI 분석 (최후의 수단) ---
                    setStatus({ type: "info", message: "AI 분석을 통해 데이터를 추출합니다..." });
                    const prompt = `JW.org URL 분석: "${url}". 고화질 MP4 및 KO, EN, ZH(pinyin 포함) 자막 데이터를 JSON으로 반환하세요.`;
                    const result = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            tools: [{ "google_search": {} }],
                            generationConfig: { responseMimeType: "application/json" }
                        })
                    }).then(r => r.json());

                    const data = JSON.parse(result.candidates?.[0]?.content?.parts?.[0]?.text || "{}");
                    if (data.videoUrl) {
                        setVideoUrl(data.videoUrl);
                        setTracks(data.tracks);
                        setStatus({ type: "success", message: "AI 분석을 완료했습니다." });
                    } else {
                        throw new Error();
                    }
                } catch (error) {
                    setStatus({ type: "error", message: "영상 로드 실패. 아카이브 동기화 후 다시 시도하거나 주소를 확인하세요." });
                } finally {
                    setIsLoading(false);
                }
            };

            const syncArchive = async () => {
                if (!archiveUrl) {
                    setStatus({ type: "warning", message: "데이터 인덱스(jw_data_index.json) 주소를 입력하세요." });
                    return;
                }
                setIsLoading(true);
                setStatus({ type: "info", message: "아카이브 동기화 중..." });
                try {
                    const res = await fetch(archiveUrl);
                    const indexList = await res.json();
                    
                    if (!Array.isArray(indexList)) {
                        setArchiveData(indexList);
                        setStatus({ type: "success", message: "데이터를 불러왔습니다." });
                        return;
                    }

                    const baseUrl = archiveUrl.substring(0, archiveUrl.lastIndexOf('/') + 1);
                    let combinedData = [];

                    for (let i = 0; i < indexList.length; i++) {
                        setStatus({ type: "info", message: `데이터 로드 중 (${i + 1}/${indexList.length})...` });
                        const chunkRes = await fetch(baseUrl + indexList[i]);
                        const chunkData = await chunkRes.json();
                        combinedData = combinedData.concat(chunkData);
                    }

                    setArchiveData(combinedData);
                    setStatus({ type: "success", message: `${combinedData.length}개의 데이터를 불러왔습니다. 이제 주소창에 링크만 넣으면 자동 검색됩니다.` });
                } catch (e) {
                    setStatus({ type: "error", message: "동기화 실패. 주소나 파일 형식을 확인하세요." });
                } finally {
                    setIsLoading(false);
                }
            };

            const togglePlay = () => {
                if (!videoRef.current) return;
                if (videoRef.current.paused) {
                    videoRef.current.play().catch(() => {});
                    setIsPlaying(true);
                } else {
                    videoRef.current.pause();
                    setIsPlaying(false);
                }
            };

            const handleTimeUpdate = () => {
                if (!videoRef.current) return;
                const time = videoRef.current.currentTime;
                setCurrentTime(time);
                if (isLooping && loopA !== null && loopB !== null && time >= loopB) videoRef.current.currentTime = loopA;

                const findIdx = (track) => (track || []).findIndex(t => time >= t.start && time < t.end);
                setActiveIndices({ ko: findIdx(tracks.ko), zh: findIdx(tracks.zh), en: findIdx(tracks.en) });
            };

            const mergedList = useMemo(() => {
                const leadTrack = tracks[anchorLang] || [];
                return leadTrack.map((item, idx) => {
                    const midTime = (item.start + item.end) / 2;
                    const findP = (track) => (track || []).find(t => midTime >= t.start && midTime < t.end) || (track || []).find(t => item.start >= t.start && item.start < t.end);
                    return { id: idx, start: item.start, end: item.end, ko: anchorLang === 'ko' ? item.text : findP(tracks.ko)?.text || "", zh: anchorLang === 'zh' ? item.text : findP(tracks.zh)?.text || "", pinyin: anchorLang === 'zh' ? item.pinyin : findP(tracks.zh)?.pinyin || "", en: anchorLang === 'en' ? item.text : findP(tracks.en)?.text || "" };
                });
            }, [tracks, anchorLang]);

            const filteredList = mergedList.filter(item => `${item.ko} ${item.zh} ${item.en} ${item.pinyin}`.toLowerCase().includes(searchTerm.toLowerCase()));
            
            const filteredArchive = archiveData.filter(v => 
                v.title?.toLowerCase().includes(archiveSearch.toLowerCase()) || 
                v.category?.toLowerCase().includes(archiveSearch.toLowerCase()) ||
                v.natural_key?.toLowerCase().includes(archiveSearch.toLowerCase())
            );

            return (
                <div className="flex flex-col h-screen max-h-screen bg-slate-50 font-sans">
                    <header className="h-14 bg-white border-b flex items-center px-4 lg:px-6 shrink-0 z-50 shadow-sm">
                        <div className="flex items-center gap-4 w-full max-w-7xl mx-auto">
                            <div className="bg-[#1E6F54] p-1.5 rounded-lg text-white font-black text-xs">JW PRO</div>
                            <div className="flex-1 flex gap-2">
                                <input 
                                    type="text" 
                                    placeholder="JW.org 영상 링크 붙여넣기 (아카이브 자동 검색됨)..."
                                    className="flex-1 px-4 py-2 bg-slate-100 rounded-xl text-sm outline-none focus:ring-2 focus:ring-emerald-500 transition-all border-none"
                                    value={inputUrl}
                                    onChange={(e) => setInputUrl(e.target.value)}
                                    onKeyDown={(e) => e.key === 'Enter' && handleAnalyze()}
                                />
                                <button onClick={handleAnalyze} disabled={isLoading} className="px-5 py-2 bg-[#1E6F54] text-white rounded-xl text-sm font-bold shadow-md active:scale-95 disabled:opacity-50 transition-all">
                                    불러오기
                                </button>
                                <button onClick={() => setShowArchive(!showArchive)} className={`p-2 rounded-xl border transition-all ${showArchive ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-400 border-slate-200'}`}>
                                    <Icon name="database" size={18} />
                                </button>
                            </div>
                        </div>
                    </header>

                    {status.message && (
                        <div className={`status-banner py-2 px-6 flex items-center justify-center gap-3 text-xs font-bold transition-all shadow-inner ${status.type === 'error' ? 'bg-red-100 text-red-600' : status.type === 'info' ? 'bg-blue-50 text-blue-600' : 'bg-emerald-100 text-emerald-700'}`}>
                            <Icon name={status.type === 'error' ? 'alert' : 'info'} size={14} /> {status.message}
                        </div>
                    )}

                    <main className="flex-1 flex flex-col lg:flex-row overflow-hidden p-3 lg:p-6 gap-6 max-w-[1800px] mx-auto w-full">
                        <div className="flex-1 flex flex-col gap-4 min-w-0 overflow-y-auto custom-scrollbar">
                            {showArchive && (
                                <div className="bg-white p-5 rounded-3xl border border-emerald-100 shadow-sm space-y-4 animate-in">
                                    <h4 className="text-sm font-black text-emerald-800 flex items-center gap-2 uppercase tracking-tighter"><Icon name="database" size={16}/> 아카이브 매니저</h4>
                                    <p className="text-[10px] text-slate-500">데이터를 동기화하면 주소창에 링크를 넣었을 때 아카이브에서 먼저 검색합니다.</p>
                                    <div className="flex gap-2">
                                        <input type="text" placeholder="jw_data_index.json의 Raw URL을 입력하세요..." className="flex-1 px-3 py-2 bg-slate-50 border rounded-lg text-xs outline-none focus:border-emerald-500" value={archiveUrl} onChange={e => setArchiveUrl(e.target.value)} />
                                        <button onClick={syncArchive} className="px-4 py-2 bg-emerald-600 text-white rounded-lg text-xs font-bold active:scale-95 transition-all">동기화</button>
                                    </div>
                                    <div className="relative group">
                                        <Icon name="search" size={12} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-300"/>
                                        <input type="text" placeholder="동기화된 아카이브 내 검색..." className="w-full pl-8 pr-4 py-1.5 border-b text-xs outline-none focus:border-emerald-500" value={archiveSearch} onChange={e => setArchiveSearch(e.target.value)} />
                                    </div>
                                    <div className="max-h-60 overflow-y-auto space-y-1 text-[11px] custom-scrollbar pr-2">
                                        {filteredArchive.length > 0 ? filteredArchive.map((v, i) => (
                                            <div key={i} className="p-2 border border-slate-50 rounded-lg hover:bg-emerald-50 cursor-pointer flex justify-between items-center group transition-colors" onClick={() => { setVideoUrl(v.url); setTracks(v.scripts); setShowArchive(false); setInputUrl(v.url); }}>
                                                <div className="flex flex-col">
                                                    <span className="font-bold text-slate-700">{v.title}</span>
                                                    <span className="text-[9px] text-slate-400">{v.category} ({v.natural_key})</span>
                                                </div>
                                                <span className="text-slate-300 group-hover:text-emerald-500 font-mono whitespace-nowrap ml-2">{v.date}</span>
                                            </div>
                                        )) : <p className="text-slate-300 italic text-center py-6">데이터가 없거나 검색 결과가 없습니다.</p>}
                                    </div>
                                </div>
                            )}

                            <div className="aspect-video bg-black rounded-[2rem] overflow-hidden shadow-2xl relative border-4 border-white group transition-all">
                                {videoUrl ? <video key={videoUrl} ref={videoRef} src={videoUrl} className="w-full h-full object-contain cursor-pointer" onTimeUpdate={handleTimeUpdate} onLoadedMetadata={e => setDuration(e.target.duration)} onClick={togglePlay} playsInline /> 
                                : <div className="w-full h-full flex flex-col items-center justify-center text-slate-500 gap-4"><Icon name="play" size={48} className="opacity-10"/><p className="text-sm font-medium">학습을 위해 영상을 불러오세요.</p></div>}
                                
                                <div className="absolute inset-x-0 bottom-0 p-6 flex flex-col items-center pointer-events-none text-center h-1/2 justify-end">
                                    <div className="space-y-2 drop-shadow-2xl">
                                        {showLangs.ko && activeIndices.ko !== -1 && tracks.ko[activeIndices.ko] && <div className="bg-black/70 backdrop-blur-sm text-white px-5 py-2 rounded-2xl inline-block text-outline font-medium" style={{ fontSize: `${videoFontSize}px` }}>{tracks.ko[activeIndices.ko].text}</div>}
                                        {showLangs.zh && activeIndices.zh !== -1 && tracks.zh[activeIndices.zh] && (
                                            <div className="flex flex-col items-center">
                                                {showPinyin && <div className="bg-black/50 text-emerald-300 px-2 py-0.5 rounded-md mb-1 text-outline" style={{ fontSize: `${videoFontSize * 0.6}px` }}>{tracks.zh[activeIndices.zh].pinyin}</div>}
                                                <div className="bg-black/70 backdrop-blur-sm text-white px-5 py-2 rounded-2xl inline-block text-outline font-medium" style={{ fontSize: `${videoFontSize}px` }}>{tracks.zh[activeIndices.zh].text}</div>
                                            </div>
                                        )}
                                        {showLangs.en && activeIndices.en !== -1 && tracks.en[activeIndices.en] && <div className="bg-black/70 backdrop-blur-sm text-white px-5 py-2 rounded-2xl inline-block text-outline font-medium" style={{ fontSize: `${videoFontSize}px` }}>{tracks.en[activeIndices.en].text}</div>}
                                    </div>
                                </div>
                            </div>

                            <div className="bg-white p-5 rounded-[2rem] shadow-sm border border-slate-200 space-y-4">
                                <div className="flex items-center gap-4">
                                    <button onClick={togglePlay} className="w-12 h-12 rounded-2xl bg-[#1E6F54] text-white flex items-center justify-center shadow-lg active:scale-90 transition-all"><Icon name={isPlaying ? "pause" : "play"} size={20} /></button>
                                    <div className="flex-1">
                                        <div className="flex justify-between text-[10px] font-black text-slate-400 mb-1 px-1 uppercase tracking-tighter"><span>PLAYBACK STATUS</span><span className="font-mono">{Math.floor(currentTime)}s / {Math.floor(duration)}s</span></div>
                                        <div className="h-2 bg-slate-100 rounded-full cursor-pointer relative overflow-hidden" onClick={e => { const r = e.currentTarget.getBoundingClientRect(); if(duration > 0) videoRef.current.currentTime = ((e.clientX-r.left)/r.width)*duration; }}>
                                            <div className="h-full bg-[#1E6F54] transition-all" style={{ width: `${(currentTime/(duration||1))*100}%` }} />
                                            {loopA !== null && <div className="absolute h-full w-0.5 bg-red-400" style={{ left: `${(loopA/duration)*100}%` }} />}
                                            {loopB !== null && <div className="absolute h-full w-0.5 bg-red-400" style={{ left: `${(loopB/duration)*100}%` }} />}
                                        </div>
                                    </div>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 pt-2 border-t border-slate-100">
                                    <div className="space-y-4">
                                        <div className="space-y-2">
                                            <label className="text-[10px] font-black text-slate-500 uppercase flex items-center gap-1.5"><Icon name="settings" size={12}/> 학습 배속</label>
                                            <div className="flex p-1 bg-slate-100 rounded-xl">
                                                {[0.8, 1.0, 1.2, 1.5].map(r => <button key={r} onClick={() => { setPlaybackRate(r); if(videoRef.current) videoRef.current.playbackRate = r; }} className={`flex-1 py-1.5 rounded-lg text-[10px] font-bold transition-all ${playbackRate === r ? 'bg-white shadow-sm text-[#1E6F54]' : 'text-slate-500'}`}>{r}x</button>)}
                                            </div>
                                        </div>
                                        <div className="space-y-2">
                                            <label className="text-[10px] font-black text-slate-500 uppercase flex items-center gap-1.5">구간 반복</label>
                                            <div className="flex gap-2">
                                                <button onClick={() => setLoopA(currentTime)} className={`flex-1 py-2 text-[10px] font-bold rounded-xl border transition-all ${loopA !== null ? 'bg-emerald-50 border-emerald-200 text-emerald-700' : 'bg-white text-slate-400 border-slate-200'}`}>{loopA !== null ? `A:${Math.floor(loopA)}s` : 'A설정'}</button>
                                                <button onClick={() => setLoopB(currentTime)} className={`flex-1 py-2 text-[10px] font-bold rounded-xl border transition-all ${loopB !== null ? 'bg-emerald-50 border-emerald-200 text-emerald-700' : 'bg-white text-slate-400 border-slate-200'}`}>{loopB !== null ? `B:${Math.floor(loopB)}s` : 'B설정'}</button>
                                                <button onClick={() => setIsLooping(!isLooping)} disabled={loopA === null || loopB === null} className={`flex-1 py-2 text-[10px] font-bold rounded-xl transition-all ${isLooping ? 'bg-[#1E6F54] text-white shadow-md' : 'bg-slate-200 text-slate-400'}`}>반복ON</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="space-y-4">
                                        <div className="space-y-2">
                                            <label className="text-[10px] font-black text-slate-500 uppercase">자막 언어</label>
                                            <div className="flex gap-2">
                                                {['ko', 'zh', 'en'].map(l => <button key={l} onClick={() => setShowLangs(p => ({...p, [l]: !p[l]}))} className={`flex-1 py-2 rounded-xl text-xs font-bold transition-all border ${showLangs[l] ? 'bg-slate-900 text-white border-slate-900' : 'bg-white text-slate-400 border-slate-200'}`}>{l.toUpperCase()}</button>)}
                                            </div>
                                        </div>
                                        <div className="space-y-2">
                                            <div className="flex justify-between items-center"><label className="text-[10px] font-black text-slate-500 uppercase">자막 크기</label><span className="text-xs font-mono text-emerald-700">{videoFontSize}px</span></div>
                                            <input type="range" min="14" max="40" value={videoFontSize} onChange={e => setVideoFontSize(parseInt(e.target.value))} className="w-full" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="w-full lg:w-[450px] bg-white rounded-[2rem] border border-slate-200 flex flex-col shadow-sm overflow-hidden min-h-[500px] lg:h-auto">
                            <div className="p-5 border-b space-y-4 bg-slate-50/50">
                                <div className="flex items-center justify-between"><h3 className="font-black text-base flex items-center gap-2 text-slate-800"><Icon name="search" size={18} className="text-[#1E6F54]" /> 스크립트</h3><div className="flex bg-white rounded-lg p-0.5 border border-slate-200">{['ko','zh','en'].map(l => <button key={l} onClick={() => setAnchorLang(l)} className={`px-2.5 py-1 rounded-md text-[10px] font-bold transition-all ${anchorLang === l ? 'bg-[#1E6F54] text-white' : 'text-slate-400'}`}>{l.toUpperCase()}</button>)}</div></div>
                                <div className="relative group"><Icon name="search" size={14} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" /><input type="text" placeholder="스크립트 내용 검색..." className="w-full pl-9 pr-4 py-2.5 bg-white border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-emerald-500/20" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} /></div>
                            </div>

                            <div ref={scrollRef} className="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar">
                                {filteredList.length > 0 ? filteredList.map((item, idx) => {
                                    const isActive = (anchorLang === 'ko' && activeIndices.ko === idx) || (anchorLang === 'zh' && activeIndices.zh === idx) || (anchorLang === 'en' && activeIndices.en === idx);
                                    return (
                                        <div key={idx} ref={el => itemRefs.current[idx] = el} onClick={() => { videoRef.current.currentTime = item.start; videoRef.current.play(); setIsPlaying(true); }} className={`p-4 rounded-2xl cursor-pointer border transition-all relative group ${isActive ? 'bg-emerald-50 border-emerald-500/30 shadow-sm' : 'bg-white border-slate-100 hover:border-emerald-100'}`}>
                                            <div className="flex justify-between items-center mb-2"><span className={`text-[9px] font-mono font-bold px-1.5 py-0.5 rounded ${isActive ? 'bg-[#1E6F54] text-white' : 'bg-slate-100 text-slate-400'}`}>{Math.floor(item.start)}s</span><button onClick={e => { e.stopPropagation(); window.open(`https://dict.naver.com/search.nhn?query=${encodeURIComponent(item[anchorLang])}`, '_blank'); }} className="opacity-0 group-hover:opacity-100 text-[#1E6F54] text-[10px] font-bold flex items-center gap-1 transition-opacity"><Icon name="external" size={10} /> 사전</button></div>
                                            <div className="space-y-2.5">
                                                {showLangs.ko && item.ko && <p className="leading-snug text-slate-800" style={{ fontSize: `${scriptFontSize}px` }}>{item.ko}</p>}
                                                {showLangs.zh && item.zh && (
                                                    <div className="space-y-1">
                                                        {showPinyin && item.pinyin && <p className="text-emerald-600 leading-none" style={{ fontSize: `${scriptFontSize * 0.75}px` }}>{item.pinyin}</p>}
                                                        <p className="leading-snug text-slate-800" style={{ fontSize: `${scriptFontSize}px` }}>{item.zh}</p>
                                                    </div>
                                                )}
                                                {showLangs.en && item.en && <p className="leading-snug text-slate-500" style={{ fontSize: `${scriptFontSize * 0.95}px` }}>{item.en}</p>}
                                            </div>
                                        </div>
                                    );
                                }) : <div className="text-center py-20 text-slate-300 italic text-xs">스크립트가 로드되지 않았습니다.</div>}
                            </div>
                        </div>
                    </main>

                    <footer className="h-8 bg-white border-t flex items-center justify-between px-6 shrink-0 text-[9px] font-bold text-slate-300 uppercase tracking-widest">
                        <span>JW MULTIPLE PLAYER V4.1 - ARCHIVE AUTO-SEARCH</span>
                        <span>BY COLLECTOR LOGIC</span>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
